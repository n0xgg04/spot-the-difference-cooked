This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.cursor/
  rules/
    ruke.mdc
.github/
  copilot-instructions.md
admin/
  src/
    main/
      java/
        com/
          ltm/
            game/
              admin/
                Database.java
                ImageSetRepository.java
                UploaderApp.java
      resources/
        admin-config.properties
  .gitignore
  pom.xml
  README.md
client/
  src/
    main/
      java/
        com/
          ltm/
            game/
              client/
                controllers/
                  LeaderboardController.java
                  LobbyController.java
                  LoginController.java
                  ResultController.java
                models/
                  LobbyUserRow.java
                services/
                  AudioService.java
                  NetworkClient.java
                views/
                  GameView.java
                ClientApp.java
      resources/
        css/
          login.css
        fxml/
          leaderboard.fxml
          lobby.fxml
          login.fxml
          result.fxml
        images/
          v2/
            forest-8227410.jpg
          anh_moi_choi.jpg
          avatar_home.png
        sounds/
          nhac_ingame.mp3
          phai_chiu.mp3
          README.md
          ving_quang.mp3
          y_ke_que.mp3
          ye_ƒëoan_dung_roi.mp3
        client-config.properties
  .gitignore
  Dockerfile
  pom.xml
db/
  schema.sql
  seed.sql
server/
  src/
    main/
      java/
        com/
          ltm/
            game/
              server/
                ClientHandler.java
                ClientSession.java
                Database.java
                GameServer.java
                GameService.java
                ImageSetRepository.java
                LobbyService.java
                MatchRepository.java
                ServerProperties.java
                UserRepository.java
      resources/
        server-config.properties
  .gitignore
  Dockerfile
  pom.xml
shared/
  src/
    main/
      java/
        com/
          ltm/
            game/
              shared/
                models/
                  LeaderboardEntry.java
                  User.java
                  UserStatus.java
                Message.java
                Protocol.java
  pom.xml
.gitignore
docker-compose.yaml
Dockerfile
Dump20251102.sql
Makefile
pom.xml
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".cursor/rules/ruke.mdc">
---
alwaysApply: true
---

NEVER WRITE COMMENT TO CODE PLEASE
</file>

<file path="client/src/main/resources/css/login.css">
/* Login Screen Styles */

.root {
  -fx-font-family: "Segoe UI", "Arial", sans-serif;
}

/* Login Button Hover Effect */
.login-button {
  -fx-font-size: 18px;
  -fx-font-weight: bold;
  -fx-padding: 16px 50px;
  -fx-background-color: linear-gradient(to right, #228b22, #32cd32);
  -fx-text-fill: white;
  -fx-background-radius: 15px;
  -fx-cursor: hand;
  -fx-effect: dropshadow(gaussian, rgba(34, 139, 34, 0.6), 12, 0.6, 0, 4);
  -fx-transition: all 0.3s ease;
}

.login-button:hover {
  -fx-background-color: linear-gradient(to right, #32cd32, #3cb371);
  -fx-scale-x: 1.05;
  -fx-scale-y: 1.05;
  -fx-effect: dropshadow(gaussian, rgba(50, 205, 50, 0.8), 20, 0.7, 0, 6);
}

.login-button:pressed {
  -fx-scale-x: 0.98;
  -fx-scale-y: 0.98;
  -fx-background-color: linear-gradient(to right, #1e7e1e, #2eb82e);
}

/* Text Field Focus Effect */
.text-field:focused,
.password-field:focused {
  -fx-border-color: rgba(50, 205, 50, 1) !important;
  -fx-border-width: 3px !important;
  -fx-effect: dropshadow(gaussian, rgba(50, 205, 50, 0.6), 12, 0.6, 0, 3);
}

/* Smooth transitions */
.text-field,
.password-field {
  -fx-transition: border-color 0.3s ease, box-shadow 0.3s ease;
}
</file>

<file path=".github/copilot-instructions.md">
<!--
This file is generated automatically by an AI assistant because the workspace
contained no discoverable project files on 2025-10-25. It is intended to
give concrete, repository-specific guidance for AI coding agents. Update this
file manually when the repository gains source files so guidance can be
populated with real examples discovered in the tree.
-->

# Copilot / AI agent quick start for this repository

This repository appears empty at c:\Users\PC\OneDrive\Desktop\game (no files
detected as of 2025-10-25). The guidance below tells an AI agent exactly what
to do to become productive once project files are added, and what evidence to
look for when inferring the project's architecture, workflows and conventions.

1. Confirm repo state

   - If the workspace is empty, report: "no source files found" and ask the
     user whether they intended to work in a different folder or to push code.

2. Primary discovery checklist (run in repository root)

   - Look for language/build manifests in this order:
     - `package.json`, `pnpm-lock.yaml`, `yarn.lock` (Node.js)
     - `pyproject.toml`, `requirements.txt`, `setup.py` (Python)
     - `go.mod` (Go)
     - `Cargo.toml` (Rust)
     - `Makefile`, `Dockerfile`, `README.md`, `.github/workflows/`
   - If you find one of these files, record it verbatim in your analysis and
     follow the specific commands listed below for build/test commands.

3. How to infer architecture and intent (what to look for)

   - Monorepo vs single package: multiple top-level language manifests (e.g.
     more than one `package.json` or a `workspaces` key) means monorepo.
   - Service boundaries: directories named `api`, `server`, `backend`,
     `client`, `ui`, `worker` usually map to components. Look for `Dockerfile`
     and `.github/workflows` that build specific folders.
   - Data flow hints: presence of `docker-compose.yml`, `k8s/`, `migrations/`,
     or config files containing DB connection strings (`DATABASE_URL`) imply
     persistence and integration points.
   - Integrations: search for `aws`, `gcp`, `azure`, `rabbitmq`, `kafka`,
     `sqs`, `stripe`, `auth0` keywords to surface external dependencies.

4. Concrete, reproducible developer workflows

   - Node.js (if `package.json` exists):
     ```powershell
     npm install
     npm test
     npm run build
     ```
   - Python (if `pyproject.toml`/`requirements.txt` exists):
     ```powershell
     python -m venv .venv; .\.venv\Scripts\Activate.ps1; pip install -r requirements.txt; pytest -q
     ```
   - Docker-based: if `Dockerfile` or `docker-compose.yml` found:
     ```powershell
     docker build -t repo-image .
     docker-compose up --build
     ```
   - CI: inspect `.github/workflows/*` to see test/build matrix and mirror it
     locally if necessary.

5. Project-specific conventions to surface (fill when files present)

   - Note any non-standard folder names or patterns and add examples, e.g.
     "This repo keeps services in `services/<name>/` and shared code in
     `libs/<name>/` ‚Äî use relative imports `@libs/...` when editing." Replace
     this section with discovered conventions.

6. What to include in a code-change suggestion

   - One-line summary of change and the target file(s).
   - Minimal, self-contained edit that preserves local style. Prefer small
     focused patches. Reference the exact file path and function/class name.
   - When adding tests, place them adjacent to the changed code following the
     repo pattern (e.g. `__tests__`, `tests/`, or `*.spec.ts`).

7. When you cannot find evidence

   - Stop and ask the user one concise question: e.g. "I couldn't find source
     code in the workspace ‚Äî are you working in a different folder or should I
     initialize a new project here?"

8. Update this file after discovery
   - Replace the top section with a summarized, concrete checklist of files
     and commands actually found. Keep the guidance short (20‚Äì50 lines).

If you'd like, I can populate specific examples after you add project files or
point me at the intended project directory. What should I do next?
</file>

<file path="admin/src/main/java/com/ltm/game/admin/Database.java">
package com.ltm.game.admin;

import java.sql.Connection;
import java.sql.DriverManager;
import java.util.Properties;

public class Database {
    private static String url;
    private static String user;
    private static String pass;
    static {
        try {
            Properties props = new Properties();
            try (var in = Database.class.getClassLoader().getResourceAsStream("admin-config.properties")) {
                if (in != null) props.load(in);
            }
            url = props.getProperty("db.url", "jdbc:mysql://localhost:3306/spotgame");
            user = props.getProperty("db.user", "root");
            pass = props.getProperty("db.password", "");
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
    public static Connection getConnection() throws Exception {
        return DriverManager.getConnection(url, user, pass);
    }
}
</file>

<file path="admin/src/main/java/com/ltm/game/admin/ImageSetRepository.java">
package com.ltm.game.admin;

import java.sql.*;
import java.util.List;

public class ImageSetRepository {

    public long insertImageSet(String name, int width, int height, String leftPath, String rightPath) throws Exception {
        String sql = "INSERT INTO image_sets(name, width, height, img_left_path, img_right_path) VALUES (?,?,?,?,?)";
        try (Connection c = Database.getConnection();
             PreparedStatement ps = c.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
            ps.setString(1, name);
            ps.setInt(2, width);
            ps.setInt(3, height);
            ps.setString(4, leftPath);
            ps.setString(5, rightPath);
            ps.executeUpdate();
            try (ResultSet rs = ps.getGeneratedKeys()) {
                if (rs.next()) return rs.getLong(1);
            }
        }
        throw new IllegalStateException("Failed to insert image set");
    }

    public void insertDifferences(long setId, List<DPoint> points) throws Exception {
        if (points == null || points.isEmpty()) return;
        String sql = "INSERT INTO image_differences(set_id, x, y, radius) VALUES (?,?,?,?)";
        try (Connection c = Database.getConnection();
             PreparedStatement ps = c.prepareStatement(sql)) {
            for (DPoint p : points) {
                ps.setLong(1, setId);
                ps.setInt(2, (int)Math.round(p.x));
                ps.setInt(3, (int)Math.round(p.y));
                ps.setInt(4, p.radius);
                ps.addBatch();
            }
            ps.executeBatch();
        }
    }

    public static class DPoint {
        public final double x; public final double y; public final int radius;
        public DPoint(double x, double y, int radius) { this.x=x; this.y=y; this.radius=radius; }
    }
}
</file>

<file path="admin/src/main/java/com/ltm/game/admin/UploaderApp.java">
package com.ltm.game.admin;

import javafx.application.Application;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.canvas.Canvas;
import javafx.scene.canvas.GraphicsContext;
import javafx.scene.control.*;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.stage.FileChooser;
import javafx.stage.Stage;

import java.io.File;
import java.io.FileInputStream;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.List;

public class UploaderApp extends Application {
    private Image leftImg; private Image rightImg;
    private File leftFile; private File rightFile;
    private final List<ImageSetRepository.DPoint> points = new ArrayList<>();
    private final Canvas overlay = new Canvas(900, 450);
    private final TextField nameField = new TextField();
    private final Spinner<Integer> radiusSpinner = new Spinner<>(5, 100, 40); // Increased default to 40, max to 100
    private final Label status = new Label();

    public static void main(String[] args) { launch(args); }

    @Override
    public void start(Stage stage) {
        stage.setTitle("üé® Admin - Upload ·∫¢nh T√¨m ƒêi·ªÉm Kh√°c Bi·ªát");
        
        // Legacy preview ImageViews (no longer shown; we now draw directly on the Canvas)
        var leftView = new ImageView();
        var rightView = new ImageView();
        leftView.setFitWidth(400); leftView.setFitHeight(400); leftView.setPreserveRatio(true);
        rightView.setFitWidth(400); rightView.setFitHeight(400); rightView.setPreserveRatio(true);

        // Styled buttons
        Button loadLeft = createStyledButton("üìÇ Ch·ªçn ·∫£nh tr√°i", "#3498db");
        Button loadRight = createStyledButton("üìÇ Ch·ªçn ·∫£nh ph·∫£i", "#9b59b6");
        Button clearPts = createStyledButton("üóë X√≥a ƒëi·ªÉm", "#e74c3c");
        Button saveBtn = createStyledButton("üíæ L∆∞u v√†o DB", "#27ae60");

        nameField.setPromptText("Nh·∫≠p t√™n b·ªô ·∫£nh...");
        nameField.setStyle(
            "-fx-font-size: 14px;" +
            "-fx-padding: 10px;" +
            "-fx-background-radius: 8px;" +
            "-fx-border-color: #3498db;" +
            "-fx-border-width: 2px;" +
            "-fx-border-radius: 8px;"
        );

        loadLeft.setOnAction(e -> chooseImage(stage, leftView, true));
        loadRight.setOnAction(e -> chooseImage(stage, rightView, false));
        clearPts.setOnAction(e -> { points.clear(); redraw(leftView, rightView); });
        saveBtn.setOnAction(e -> saveToDb());

        overlay.addEventHandler(MouseEvent.MOUSE_CLICKED, e -> {
            if (leftImg == null || rightImg == null) return;
            // Accept clicks inside either 400x400 preview: left at (10,10) or right at (440,10)
            double cx = e.getX() - 10; double cy = e.getY() - 10; // left box local
            boolean inLeft = !(cx < 0 || cy < 0 || cx > 400 || cy > 400);
            double rx = e.getX() - 440; double ry = e.getY() - 10; // right box local
            boolean inRight = !(rx < 0 || ry < 0 || rx > 400 || ry > 400);
            if (!inLeft && !inRight) return;
            // Use coordinates relative to whichever box was clicked (both images assumed same size)
            double localX = inLeft ? cx : rx;
            double localY = inLeft ? cy : ry;
            // Normalize to original image pixels
            double ix = (localX / 400.0) * leftImg.getWidth();
            double iy = (localY / 400.0) * leftImg.getHeight();
            int rDisp = radiusSpinner.getValue();
            int rImg = (int)Math.round(rDisp * (leftImg.getWidth() / 400.0));
            points.add(new ImageSetRepository.DPoint(ix, iy, rImg));
            redraw(leftView, rightView);
        });

        BorderPane root = new BorderPane();
        root.setStyle("-fx-background-color: #ecf0f1;");
        
        // Header with title and instructions
        VBox header = new VBox(10);
        header.setPadding(new Insets(20, 20, 15, 20));
        header.setStyle(
            "-fx-background-color: linear-gradient(to right, #3498db, #9b59b6);" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 8, 0.5, 0, 2);"
        );
        
        Label titleLabel = new Label("üé® QU·∫¢N TR·ªä - UPLOAD B·ªò ·∫¢NH");
        titleLabel.setStyle(
            "-fx-font-size: 24px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: white;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 5, 0.7, 0, 2);"
        );
        
        Label tip = new Label("üí° H∆∞·ªõng d·∫´n: Click v√†o v√πng ·∫£nh ƒë·ªÉ ƒë√°nh d·∫•u ƒëi·ªÉm kh√°c bi·ªát. ƒêi·ªÅu ch·ªânh b√°n k√≠nh v√≤ng tr√≤n b√™n ph·∫£i.");
        tip.setStyle(
            "-fx-font-size: 13px;" +
            "-fx-text-fill: rgba(255,255,255,0.95);" +
            "-fx-font-style: italic;"
        );
        tip.setWrapText(true);
        
        header.getChildren().addAll(titleLabel, tip);
        root.setTop(header);

        // Right panel - tools
        VBox tools = new VBox(15);
        tools.setPadding(new Insets(20));
        tools.setStyle(
            "-fx-background-color: white;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0.5, -2, 0);"
        );
        tools.setMinWidth(280);
        
        // Name field section
        Label nameLabel = new Label("üìù T√™n b·ªô ·∫£nh:");
        nameLabel.setStyle(
            "-fx-font-size: 14px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: #2c3e50;"
        );
        
        // Buttons section
        Label uploadLabel = new Label("üì§ T·∫£i ·∫£nh l√™n:");
        uploadLabel.setStyle(
            "-fx-font-size: 14px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: #2c3e50;"
        );
        VBox uploadBox = new VBox(8, loadLeft, loadRight);
        
        // Radius control section
        Label radiusLabel = new Label("‚≠ï B√°n k√≠nh v√≤ng tr√≤n:");
        radiusLabel.setStyle(
            "-fx-font-size: 14px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: #2c3e50;"
        );
        
        radiusSpinner.setPrefWidth(120);
        radiusSpinner.setStyle(
            "-fx-font-size: 13px;"
        );
        
        HBox radiusBox = new HBox(10, radiusSpinner, clearPts);
        radiusBox.setAlignment(Pos.CENTER_LEFT);
        
        // Points count label
        Label pointsCountLabel = new Label("üìç S·ªë ƒëi·ªÉm ƒë√£ ƒë√°nh d·∫•u: 0");
        pointsCountLabel.setStyle(
            "-fx-font-size: 13px;" +
            "-fx-text-fill: #7f8c8d;" +
            "-fx-padding: 8px;" +
            "-fx-background-color: #ecf0f1;" +
            "-fx-background-radius: 6px;"
        );
        
        // Update points count on redraw
        radiusSpinner.valueProperty().addListener((obs, old, val) -> {
            pointsCountLabel.setText("üìç S·ªë ƒëi·ªÉm ƒë√£ ƒë√°nh d·∫•u: " + points.size());
        });
        
        Separator sep = new Separator();
        
        // Status label
        status.setStyle(
            "-fx-font-size: 12px;" +
            "-fx-text-fill: #34495e;" +
            "-fx-padding: 10px;" +
            "-fx-background-color: #f8f9fa;" +
            "-fx-background-radius: 6px;" +
            "-fx-border-color: #dee2e6;" +
            "-fx-border-width: 1px;" +
            "-fx-border-radius: 6px;"
        );
        status.setWrapText(true);
        status.setPrefHeight(80);
        
        tools.getChildren().addAll(
            nameLabel, nameField,
            uploadLabel, uploadBox,
            radiusLabel, radiusBox,
            pointsCountLabel,
            sep,
            saveBtn,
            status
        );
        
        root.setRight(tools);
        root.setCenter(overlay);

        Scene scene = new Scene(root, 1200, 560);
        stage.setScene(scene);
        stage.show();
    }
    
    private Button createStyledButton(String text, String color) {
        Button btn = new Button(text);
        btn.setMaxWidth(Double.MAX_VALUE);
        btn.setStyle(
            "-fx-font-size: 13px;" +
            "-fx-font-weight: bold;" +
            "-fx-padding: 12px 20px;" +
            "-fx-background-color: " + color + ";" +
            "-fx-text-fill: white;" +
            "-fx-background-radius: 8px;" +
            "-fx-cursor: hand;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 5, 0.5, 0, 2);"
        );
        
        btn.setOnMouseEntered(e -> btn.setStyle(
            btn.getStyle() + "-fx-scale-x: 1.02; -fx-scale-y: 1.02;"
        ));
        btn.setOnMouseExited(e -> btn.setStyle(
            btn.getStyle().replace("-fx-scale-x: 1.02; -fx-scale-y: 1.02;", "")
        ));
        
        return btn;
    }

    private void chooseImage(Stage stage, ImageView view, boolean left) {
        FileChooser fc = new FileChooser();
        fc.getExtensionFilters().add(new FileChooser.ExtensionFilter("Images", "*.png", "*.jpg", "*.jpeg"));
        File file = fc.showOpenDialog(stage);
        if (file != null) {
            try {
                Image img = new Image(new FileInputStream(file));
                view.setImage(img);
                if (left) { leftImg = img; leftFile = file; }
                else { rightImg = img; rightFile = file; }
                redraw(null, null);
            } catch (Exception ex) {
                status.setText("L·ªói m·ªü ·∫£nh: "+ex.getMessage());
            }
        }
    }

    private void redraw(ImageView leftView, ImageView rightView) {
        GraphicsContext g = overlay.getGraphicsContext2D();
        g.clearRect(0,0,overlay.getWidth(), overlay.getHeight());
        // Draw background
        g.setFill(Color.web("#f7f7f7"));
        g.fillRect(0,0,overlay.getWidth(), overlay.getHeight());
        // Draw previews (images first so guides and points are on top)
        if (leftImg != null) {
            g.drawImage(leftImg, 10, 10, 400, 400);
        } else {
            drawPlaceholder(g, 10, 10, 400, 400, "Ch·ªçn ·∫£nh tr√°i");
        }
        if (rightImg != null) {
            g.drawImage(rightImg, 440, 10, 400, 400);
        } else {
            drawPlaceholder(g, 440, 10, 400, 400, "Ch·ªçn ·∫£nh ph·∫£i");
        }
        // Boxes
        g.setStroke(Color.GRAY);
        g.strokeRect(10, 10, 400, 400);
        g.strokeRect(440,10, 400, 400);
        // Filenames + dims footer
        g.setFill(Color.color(0,0,0,0.6));
        g.fillRect(10, 410, 400, 24);
        g.fillRect(440, 410, 400, 24);
        g.setFill(Color.WHITE);
        String leftMeta = (leftFile!=null? leftFile.getName(): "");
        String rightMeta = (rightFile!=null? rightFile.getName(): "");
        if (leftImg != null) leftMeta += String.format("  (%dx%d)", (int)leftImg.getWidth(), (int)leftImg.getHeight());
        if (rightImg != null) rightMeta += String.format("  (%dx%d)", (int)rightImg.getWidth(), (int)rightImg.getHeight());
        g.fillText(leftMeta.isEmpty()? "": leftMeta, 16, 426);
        g.fillText(rightMeta.isEmpty()? "": rightMeta, 446, 426);
        g.setStroke(Color.RED);
        if (leftImg != null) {
            for (var p : points) {
                // Convert image-space coordinates to preview space (400x400)
                double dx = (p.x / leftImg.getWidth()) * 400.0;
                double dy = (p.y / leftImg.getHeight()) * 400.0;
                double rr = p.radius * (400.0 / leftImg.getWidth());
                g.strokeOval(10 + dx - rr, 10 + dy - rr, rr*2, rr*2);
                g.strokeOval(440 + dx - rr, 10 + dy - rr, rr*2, rr*2);
            }
        }
    }

    private void drawPlaceholder(GraphicsContext g, double x, double y, double w, double h, String text) {
        g.setFill(Color.web("#ffffff"));
        g.fillRect(x, y, w, h);
        g.setStroke(Color.web("#cccccc"));
        g.setLineDashes(6);
        g.strokeRect(x+2, y+2, w-4, h-4);
        g.setLineDashes(0);
        g.setFill(Color.web("#888"));
        g.fillText(text, x + 12, y + h/2);
    }

    private void saveToDb() {
        try {
            if (leftImg == null || rightImg == null) { status.setText("Ch·ªçn ƒë·ªß 2 ·∫£nh tr∆∞·ªõc"); return; }
            if (points.isEmpty()) { status.setText("Th√™m √≠t nh·∫•t 1 ƒëi·ªÉm kh√°c bi·ªát"); return; }
            String name = nameField.getText() == null ? "" : nameField.getText().trim();
            if (name.isEmpty()) name = "set-"+System.currentTimeMillis();

            // Copy files into storage directory and save relative paths to DB
            java.util.Properties props = new java.util.Properties();
            try (var in = getClass().getClassLoader().getResourceAsStream("admin-config.properties")) {
                if (in != null) props.load(in);
            }
            String storageDir = props.getProperty("storage.dir", "content/imagesets");
            // Resolve to absolute path - need to go up to project root first
            File userDir = new File(System.getProperty("user.dir"));
            System.out.println("Current user.dir: " + userDir.getAbsolutePath());
            
            // Check if we're in admin/ subdirectory
            File base;
            if (userDir.getName().equals("admin")) {
                // Running from admin module, go up one level
                base = new File(userDir.getParentFile(), storageDir);
            } else {
                // Running from project root
                base = new File(userDir, storageDir);
            }
            
            System.out.println("Attempting to create directory: " + base.getAbsolutePath());
            if (!base.exists()) {
                boolean created = base.mkdirs();
                System.out.println("Directory created: " + created);
                if (!created && !base.exists()) {
                    status.setText("Kh√¥ng th·ªÉ t·∫°o th∆∞ m·ª•c: "+base.getAbsolutePath());
                    return;
                }
            }
            System.out.println("Storage directory exists: " + base.exists() + ", isDirectory: " + base.isDirectory());
            status.setText("Th∆∞ m·ª•c l∆∞u tr·ªØ: "+base.getAbsolutePath());
            String uniq = String.valueOf(System.currentTimeMillis());
            String leftName = uniq+"_left"+ getExt(leftFile.getName());
            String rightName = uniq+"_right"+ getExt(rightFile.getName());
            File leftDst = new File(base, leftName);
            File rightDst = new File(base, rightName);
            
            Files.copy(leftFile.toPath(), leftDst.toPath(), java.nio.file.StandardCopyOption.REPLACE_EXISTING);
            Files.copy(rightFile.toPath(), rightDst.toPath(), java.nio.file.StandardCopyOption.REPLACE_EXISTING);
            
            if (!leftDst.exists() || !rightDst.exists()) {
                status.setText("Copy file th·∫•t b·∫°i. Ki·ªÉm tra quy·ªÅn ghi th∆∞ m·ª•c.");
                return;
            }

            int width = (int)Math.round(leftImg.getWidth());
            int height = (int)Math.round(leftImg.getHeight());

            ImageSetRepository repo = new ImageSetRepository();
            long setId = repo.insertImageSet(name, width, height, leftName, rightName);
            repo.insertDifferences(setId, points);
            status.setText("ƒê√£ l∆∞u b·ªô ·∫£nh #"+setId+" ("+leftDst.getAbsolutePath()+") v·ªõi "+points.size()+" ƒëi·ªÉm");
            points.clear();
            redraw(null, null);
        } catch (Exception e) {
            status.setText("L·ªói: "+e.getClass().getSimpleName()+" - "+e.getMessage());
            e.printStackTrace();
        }
    }

    private static String getExt(String filename) {
        int i = filename.lastIndexOf('.');
        return i>=0? filename.substring(i) : "";
    }
}
</file>

<file path="admin/src/main/resources/admin-config.properties">
db.url=jdbc:mysql://localhost:3306/spotgame
db.user=root
db.password=Hung23072004
storage.dir=admin/content/imagesets
</file>

<file path="admin/.gitignore">
target
</file>

<file path="admin/README.md">
# Admin Uploader

A small JavaFX tool to create image sets for the Spot The Difference game.

Features:

- Load a left and a right image (PNG/JPG)
- Click on the left image area to add difference points (radius configurable)
- Preview circles mirrored on both images
- Save to MySQL database (tables `image_sets`, `image_differences`)

## Configure

Edit `admin/src/main/resources/admin-config.properties` to point to your MySQL instance.

## Run

In the repository root:

```powershell
mvn -pl admin javafx:run
```

## Database schema

If you haven't applied the schema additions yet, run:

```powershell
mysql -u root -p < db/schema.sql
```
</file>

<file path="client/src/main/java/com/ltm/game/client/controllers/LeaderboardController.java">
package com.ltm.game.client.controllers;

import com.ltm.game.shared.Message;
import com.ltm.game.shared.Protocol;
import com.ltm.game.client.services.NetworkClient;
import javafx.application.Platform;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.control.Label;
import javafx.scene.layout.*;

import java.util.List;
import java.util.Map;
import java.util.function.Consumer;

public class LeaderboardController {
    @FXML
    private VBox entriesContainer;

    private NetworkClient networkClient;
    private Consumer<Void> onBack;

    public void setNetworkClient(NetworkClient client) {
        this.networkClient = client;
    }

    public void setOnBack(Consumer<Void> callback) {
        this.onBack = callback;
    }

    @FXML
    private void initialize() {
        if (networkClient != null) {
            requestLeaderboardData();
        }
    }

    public void requestLeaderboardData() {
        if (networkClient != null) {
            networkClient.send(new Message(Protocol.LEADERBOARD, null));
            
            networkClient.addHandler(Protocol.LEADERBOARD, msg -> {
                Platform.runLater(() -> {
                    @SuppressWarnings("unchecked")
                    List<Map<String, Object>> entries = (List<Map<String, Object>>) msg.payload;
                    updateLeaderboard(entries);
                });
            });
        }
    }

    private void updateLeaderboard(List<Map<String, Object>> entries) {
        entriesContainer.getChildren().clear();
        
        for (int i = 0; i < entries.size(); i++) {
            var entry = entries.get(i);
            int rank = i + 1;
            String playerName = String.valueOf(entry.get("username"));
            int totalPoints = ((Number) entry.get("totalPoints")).intValue();
            int totalWins = ((Number) entry.get("totalWins")).intValue();
            
            HBox entryRow = new HBox(12);
            entryRow.setAlignment(Pos.CENTER_LEFT);
            entryRow.setPadding(new Insets(10, 15, 10, 15));
            entryRow.setMaxWidth(650);
            
            String bgColor;
            if (rank == 1) {
                bgColor = "linear-gradient(to right, rgba(255,215,0,0.45), rgba(255,165,0,0.35))";
            } else if (rank == 2) {
                bgColor = "linear-gradient(to right, rgba(192,192,192,0.45), rgba(169,169,169,0.35))";
            } else if (rank == 3) {
                bgColor = "linear-gradient(to right, rgba(205,127,50,0.45), rgba(184,115,51,0.35))";
            } else {
                bgColor = "rgba(30,90,158,0.3)";
            }
            
            entryRow.setStyle(
                "-fx-background-color: " + bgColor + ";" +
                "-fx-background-radius: 10px;" +
                "-fx-border-color: rgba(100,180,255,0.4);" +
                "-fx-border-width: 1.5px;" +
                "-fx-border-radius: 10px;" +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.4), 5, 0.6, 0, 2);"
            );
            
            Label rankLabel = new Label();
            if (rank == 1) {
                rankLabel.setText("ü•á");
                rankLabel.setStyle("-fx-font-size: 28px;");
            } else if (rank == 2) {
                rankLabel.setText("ü•à");
                rankLabel.setStyle("-fx-font-size: 28px;");
            } else if (rank == 3) {
                rankLabel.setText("ü•â");
                rankLabel.setStyle("-fx-font-size: 28px;");
            } else {
                rankLabel.setText(String.valueOf(rank));
                rankLabel.setStyle(
                    "-fx-font-size: 20px;" +
                    "-fx-font-weight: bold;" +
                    "-fx-text-fill: white;" +
                    "-fx-min-width: 32px;" +
                    "-fx-alignment: center;"
                );
            }
            rankLabel.setMinWidth(38);
            rankLabel.setAlignment(Pos.CENTER);
            
            Label avatarLabel = new Label("üë§");
            avatarLabel.setStyle(
                "-fx-font-size: 24px;" +
                "-fx-background-color: rgba(255,255,255,0.2);" +
                "-fx-background-radius: 22px;" +
                "-fx-min-width: 44px;" +
                "-fx-min-height: 44px;" +
                "-fx-alignment: center;"
            );
            
            Label nameLabel = new Label(playerName);
            nameLabel.setStyle(
                "-fx-font-size: 17px;" +
                "-fx-font-weight: bold;" +
                "-fx-text-fill: white;" +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.6), 2, 0.6, 0, 1);"
            );
            nameLabel.setMinWidth(140);
            
            HBox starsBox = new HBox(3);
            starsBox.setAlignment(Pos.CENTER_LEFT);
            int fullStars = Math.min(5, totalPoints / 500);
            for (int s = 0; s < 5; s++) {
                Label star = new Label(s < fullStars ? "‚≠ê" : "‚òÜ");
                star.setStyle(
                    "-fx-font-size: 16px;" +
                    "-fx-text-fill: " + (s < fullStars ? "#FFD700" : "rgba(255,255,255,0.3)") + ";"
                );
                starsBox.getChildren().add(star);
            }
            
            Region spacer = new Region();
            HBox.setHgrow(spacer, Priority.ALWAYS);
            
            VBox pointsBox = new VBox(2);
            pointsBox.setAlignment(Pos.CENTER);
            
            Label pointsLabel = new Label(String.valueOf(totalPoints));
            pointsLabel.setStyle(
                "-fx-font-size: 22px;" +
                "-fx-font-weight: bold;" +
                "-fx-text-fill: #FFD700;" +
                "-fx-effect: dropshadow(gaussian, rgba(255,215,0,0.6), 4, 0.7, 0, 2);"
            );
            
            Label pointsTextLabel = new Label("ƒëi·ªÉm");
            pointsTextLabel.setStyle(
                "-fx-font-size: 10px;" +
                "-fx-text-fill: rgba(255,255,255,0.75);"
            );
            
            pointsBox.getChildren().addAll(pointsLabel, pointsTextLabel);
            
            VBox winsBox = new VBox(2);
            winsBox.setAlignment(Pos.CENTER);
            
            Label winsLabel = new Label(String.valueOf(totalWins));
            winsLabel.setStyle(
                "-fx-font-size: 19px;" +
                "-fx-font-weight: bold;" +
                "-fx-text-fill: #4CAF50;" +
                "-fx-effect: dropshadow(gaussian, rgba(76,175,80,0.5), 3, 0.6, 0, 1);"
            );
            
            Label winsTextLabel = new Label("th·∫Øng");
            winsTextLabel.setStyle(
                "-fx-font-size: 10px;" +
                "-fx-text-fill: rgba(255,255,255,0.75);"
            );
            
            winsBox.getChildren().addAll(winsLabel, winsTextLabel);
            
            entryRow.getChildren().addAll(
                rankLabel, 
                avatarLabel, 
                nameLabel, 
                starsBox, 
                spacer, 
                pointsBox,
                winsBox
            );
            
            entriesContainer.getChildren().add(entryRow);
        }
    }

    @FXML
    private void handleBack() {
        if (onBack != null) {
            onBack.accept(null);
        }
    }
}
</file>

<file path="client/src/main/java/com/ltm/game/client/controllers/LobbyController.java">
package com.ltm.game.client.controllers;

import com.ltm.game.shared.Message;
import com.ltm.game.shared.Protocol;
import com.ltm.game.client.models.LobbyUserRow;
import com.ltm.game.client.services.NetworkClient;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.image.Image;
import javafx.scene.layout.*;
import javafx.scene.paint.Color;
import javafx.stage.Modality;
import javafx.stage.Stage;
import javafx.util.Callback;

import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.function.Consumer;

public class LobbyController {
    @FXML
    private Label headerUserInfo;
    
    @FXML
    private TableView<LobbyUserRow> lobbyTable;
    
    @FXML
    private TableColumn<LobbyUserRow, String> colUser;
    
    @FXML
    private TableColumn<LobbyUserRow, String> colPoints;
    
    @FXML
    private TableColumn<LobbyUserRow, String> colStatus;
    
    @FXML
    private TableColumn<LobbyUserRow, Void> colAction;
    
    @FXML
    private TextField searchField;
    
    @FXML
    private CheckBox autoRefresh;
    
    @FXML
    private BorderPane rootPane;

    private ObservableList<LobbyUserRow> lobbyData = FXCollections.observableArrayList();
    private FilteredList<LobbyUserRow> filteredLobby;
    
    private NetworkClient networkClient;
    private String username;
    private String myPoints = "0";
    private String myStatus = "R·∫£nh";
    
    private Consumer<Void> onLogout;
    private Consumer<Void> onShowLeaderboard;

    public void setNetworkClient(NetworkClient client) {
        this.networkClient = client;
    }

    public void setUsername(String username) {
        this.username = username;
        updateHeaderUserInfo();
    }

    public void setTotalPoints(int points) {
        this.myPoints = String.valueOf(points);
        updateHeaderUserInfo();
    }

    public void setOnLogout(Consumer<Void> callback) {
        this.onLogout = callback;
    }

    public void setOnShowLeaderboard(Consumer<Void> callback) {
        this.onShowLeaderboard = callback;
    }

    @FXML
    private void initialize() {
        filteredLobby = new FilteredList<>(lobbyData, r -> true);
        lobbyTable.setItems(filteredLobby);
        
        colUser.setCellValueFactory(c -> c.getValue().usernameProperty());
        colPoints.setCellValueFactory(c -> c.getValue().totalPointsProperty());
        colStatus.setCellValueFactory(c -> c.getValue().statusProperty());
        colAction.setCellFactory(makeActionCellFactory());
        
        searchField.textProperty().addListener((obs, old, q) -> {
            String query = q == null ? "" : q.trim().toLowerCase();
            filteredLobby.setPredicate(row ->
                query.isEmpty() || row.getUsername().toLowerCase().contains(query));
        });
        
        try {
            var stream = getClass().getResourceAsStream("/images/avatar_home.png");
            if (stream == null) {
                stream = getClass().getResourceAsStream("/images/avatar_home.jpg");
            }
            
            if (stream != null) {
                Image bgImage = new Image(stream);
                BackgroundImage bg = new BackgroundImage(
                    bgImage,
                    BackgroundRepeat.NO_REPEAT,
                    BackgroundRepeat.NO_REPEAT,
                    BackgroundPosition.CENTER,
                    new BackgroundSize(100, 100, true, true, false, true)
                );
                rootPane.setBackground(new Background(bg));
                System.out.println("‚úì Background image loaded successfully!");
            } else {
                System.err.println("‚úó Could not find background image - using gradient fallback");
                rootPane.setStyle("-fx-background-color: linear-gradient(to bottom right, #2c3e50, #3498db);");
            }
        } catch (Exception e) {
            System.err.println("‚úó Error loading background image: " + e.getMessage());
            rootPane.setStyle("-fx-background-color: linear-gradient(to bottom right, #2c3e50, #3498db);");
        }
    }

    @FXML
    private void handleLogout() {
        myStatus = "R·∫£nh";
        updateHeaderUserInfo();
        if (onLogout != null) {
            onLogout.accept(null);
        }
    }

    @FXML
    private void handleRandomInvite() {
        var candidates = filteredLobby.filtered(r -> "idle".equalsIgnoreCase(r.getStatus()));
        if (candidates.isEmpty()) {
            new Alert(Alert.AlertType.INFORMATION, "Kh√¥ng c√≥ ai r·∫£nh.").show();
            return;
        }
        LobbyUserRow pick = candidates.get(new Random().nextInt(candidates.size()));
        networkClient.send(new Message(Protocol.INVITE_SEND, Map.of("toUser", pick.getUsername())));
    }

    @FXML
    private void handleShowLeaderboard() {
        if (onShowLeaderboard != null) {
            onShowLeaderboard.accept(null);
        }
    }

    @FXML
    private void handleToggleStatus() {
        myStatus = "R·∫£nh".equals(myStatus) ? "B·∫≠n" : "R·∫£nh";
        updateHeaderUserInfo();
    }

    public void updateLobbyList(List<Map<String, Object>> list) {
        lobbyData.clear();
        for (var u : list) {
            String name = String.valueOf(u.get("username"));
            String pts = String.valueOf(u.get("totalPoints"));
            String st = String.valueOf(u.get("status"));
            if (name != null && name.equals(username)) continue;
            lobbyData.add(new LobbyUserRow(name, pts, st));
        }
    }

    public void showInviteDialog(String fromUser) {
        Stage inviteDialog = new Stage();
        inviteDialog.initModality(Modality.APPLICATION_MODAL);
        inviteDialog.setTitle("L·ªùi m·ªùi thi ƒë·∫•u");
        inviteDialog.setResizable(false);
        
        VBox dialogContent = new VBox(20);
        dialogContent.setAlignment(Pos.CENTER);
        dialogContent.setPadding(new Insets(40, 50, 40, 50));
        
        try {
            var bgStream = getClass().getResourceAsStream("/images/anh_moi_choi.jpg");
            if (bgStream != null) {
                String imageUrl = getClass().getResource("/images/anh_moi_choi.jpg").toExternalForm();
                dialogContent.setStyle(
                    "-fx-background-image: url('" + imageUrl + "');" +
                    "-fx-background-size: cover;" +
                    "-fx-background-position: center;" +
                    "-fx-background-repeat: no-repeat;" +
                    "-fx-background-radius: 15px;" +
                    "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 20, 0.8, 0, 5);"
                );
            } else {
                dialogContent.setStyle(
                    "-fx-background-color: linear-gradient(to bottom right, #667eea, #764ba2);" +
                    "-fx-background-radius: 15px;" +
                    "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 20, 0.8, 0, 5);"
                );
            }
        } catch (Exception e) {
            dialogContent.setStyle(
                "-fx-background-color: linear-gradient(to bottom right, #667eea, #764ba2);" +
                "-fx-background-radius: 15px;" +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 20, 0.8, 0, 5);"
            );
        }
        
        Label iconLabel = new Label("‚öîÔ∏è");
        iconLabel.setStyle(
            "-fx-font-size: 48px;" +
            "-fx-effect: dropshadow(gaussian, rgba(255,255,255,0.5), 10, 0.5, 0, 0);"
        );
        
        Label headerLabel = new Label("L·ªùi m·ªùi thi ƒë·∫•u");
        headerLabel.setStyle(
            "-fx-font-size: 24px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: white;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 5, 0.5, 0, 2);"
        );
        
        Label messageLabel = new Label(fromUser + " m·ªùi b·∫°n thi ƒë·∫•u!");
        messageLabel.setStyle(
            "-fx-font-size: 18px;" +
            "-fx-text-fill: white;" +
            "-fx-font-style: italic;" +
            "-fx-padding: 15px;" +
            "-fx-background-color: rgba(255,255,255,0.2);" +
            "-fx-background-radius: 10px;"
        );
        
        HBox buttonBox = new HBox(15);
        buttonBox.setAlignment(Pos.CENTER);
        
        Button acceptBtn = new Button("‚úì Ch·∫•p nh·∫≠n");
        acceptBtn.setStyle(
            "-fx-font-size: 16px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: white;" +
            "-fx-background-color: #27ae60;" +
            "-fx-background-radius: 25px;" +
            "-fx-padding: 12px 30px;" +
            "-fx-cursor: hand;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 8, 0.5, 0, 2);"
        );
        acceptBtn.setOnAction(e -> {
            networkClient.send(new Message(Protocol.INVITE_RESPONSE, Map.of("fromUser", fromUser, "accepted", true)));
            inviteDialog.close();
        });
        
        Button declineBtn = new Button("‚úó T·ª´ ch·ªëi");
        declineBtn.setStyle(
            "-fx-font-size: 16px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: white;" +
            "-fx-background-color: #e74c3c;" +
            "-fx-background-radius: 25px;" +
            "-fx-padding: 12px 30px;" +
            "-fx-cursor: hand;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 8, 0.5, 0, 2);"
        );
        declineBtn.setOnAction(e -> {
            networkClient.send(new Message(Protocol.INVITE_RESPONSE, Map.of("fromUser", fromUser, "accepted", false)));
            inviteDialog.close();
        });
        
        buttonBox.getChildren().addAll(acceptBtn, declineBtn);
        dialogContent.getChildren().addAll(iconLabel, headerLabel, messageLabel, buttonBox);
        
        Scene dialogScene = new Scene(dialogContent);
        dialogScene.setFill(Color.TRANSPARENT);
        inviteDialog.setScene(dialogScene);
        inviteDialog.show();
    }

    public void showInviteRejected() {
        Stage notifyDialog = new Stage();
        notifyDialog.initModality(Modality.APPLICATION_MODAL);
        notifyDialog.setTitle("Th√¥ng b√°o");
        notifyDialog.setResizable(false);
        
        VBox notifyContent = new VBox(20);
        notifyContent.setAlignment(Pos.CENTER);
        notifyContent.setPadding(new Insets(30, 40, 30, 40));
        notifyContent.setStyle(
            "-fx-background-color: linear-gradient(to bottom right, #f093fb, #f5576c);" +
            "-fx-background-radius: 15px;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 20, 0.8, 0, 5);"
        );
        
        Label iconLabel = new Label("üòî");
        iconLabel.setStyle("-fx-font-size: 40px;");
        
        Label messageLabel = new Label("L·ªùi m·ªùi b·ªã t·ª´ ch·ªëi");
        messageLabel.setStyle(
            "-fx-font-size: 18px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: white;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 5, 0.5, 0, 2);"
        );
        
        Button okBtn = new Button("OK");
        okBtn.setStyle(
            "-fx-font-size: 14px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: white;" +
            "-fx-background-color: rgba(255,255,255,0.3);" +
            "-fx-background-radius: 20px;" +
            "-fx-padding: 10px 25px;" +
            "-fx-cursor: hand;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 8, 0.5, 0, 2);"
        );
        okBtn.setOnAction(e -> notifyDialog.close());
        
        notifyContent.getChildren().addAll(iconLabel, messageLabel, okBtn);
        
        Scene notifyScene = new Scene(notifyContent);
        notifyScene.setFill(Color.TRANSPARENT);
        notifyDialog.setScene(notifyScene);
        notifyDialog.show();
    }

    private void updateHeaderUserInfo() {
        if (headerUserInfo != null) {
            headerUserInfo.setText("Xin ch√†o, " + username + "  ‚Ä¢  T·ªïng ƒëi·ªÉm: " + myPoints + "  ‚Ä¢  " + myStatus);
        }
    }

    private Callback<TableColumn<LobbyUserRow, Void>, TableCell<LobbyUserRow, Void>> makeActionCellFactory() {
        return col -> new TableCell<>() {
            private final Button viewBtn = new Button("Xem");
            private final Button inviteBtn = new Button("M·ªùi");
            private final HBox box = new HBox(6, viewBtn, inviteBtn);
            
            {
                viewBtn.setOnAction(e -> {
                    LobbyUserRow row = getTableView().getItems().get(getIndex());
                    new Alert(Alert.AlertType.INFORMATION,
                        "Ng∆∞·ªùi ch∆°i: " + row.getUsername() + "\nƒêi·ªÉm: " + row.getTotalPoints() + "\nTr·∫°ng th√°i: " + row.getStatus())
                        .show();
                });
                inviteBtn.setOnAction(e -> {
                    LobbyUserRow row = getTableView().getItems().get(getIndex());
                    if (!row.getUsername().equals(username)) {
                        networkClient.send(new Message(Protocol.INVITE_SEND, Map.of("toUser", row.getUsername())));
                    }
                });
            }
            
            @Override
            protected void updateItem(Void item, boolean empty) {
                super.updateItem(item, empty);
                setGraphic(empty ? null : box);
            }
        };
    }
}
</file>

<file path="client/src/main/java/com/ltm/game/client/controllers/LoginController.java">
package com.ltm.game.client.controllers;

import com.ltm.game.shared.Message;
import com.ltm.game.shared.Protocol;
import com.ltm.game.client.services.NetworkClient;
import javafx.fxml.FXML;
import javafx.scene.control.Alert;
import javafx.scene.control.PasswordField;
import javafx.scene.control.TextField;
import javafx.animation.ScaleTransition;
import javafx.util.Duration;

import java.util.Map;
import java.util.function.BiConsumer;

public class LoginController {
    @FXML
    private TextField usernameField;
    
    @FXML
    private PasswordField passwordField;
    
    private NetworkClient networkClient;
    private BiConsumer<String, Integer> onLoginSuccess;

    public void setNetworkClient(NetworkClient client) {
        this.networkClient = client;
    }

    public void setOnLoginSuccess(BiConsumer<String, Integer> callback) {
        this.onLoginSuccess = callback;
    }

    @FXML
    private void initialize() {
        if (passwordField != null) {
            passwordField.setOnAction(e -> handleLogin());
        }
        
        addFocusAnimation(usernameField);
        addFocusAnimation(passwordField);
    }
    
    private void addFocusAnimation(javafx.scene.Node node) {
        node.focusedProperty().addListener((obs, wasFocused, isNowFocused) -> {
            ScaleTransition st = new ScaleTransition(Duration.millis(150), node);
            if (isNowFocused) {
                st.setToX(1.02);
                st.setToY(1.02);
            } else {
                st.setToX(1.0);
                st.setToY(1.0);
            }
            st.play();
        });
    }

    @FXML
    private void handleLogin() {
        String username = usernameField.getText();
        String password = passwordField.getText();
        
        if (username.isEmpty() || password.isEmpty()) {
            showError("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
            return;
        }
        
        networkClient.send(new Message(Protocol.AUTH_LOGIN, Map.of(
            "username", username,
            "password", password
        )));
    }

    public void handleAuthResult(Map<?, ?> payload) {
        boolean success = Boolean.parseBoolean(String.valueOf(payload.get("success")));
        if (success) {
            Map<?, ?> user = (Map<?, ?>) payload.get("user");
            String username = String.valueOf(user.get("username"));
            Object tp = user.get("totalPoints");
            int totalPoints = 0;
            if (tp != null) {
                if (tp instanceof Number) {
                    totalPoints = ((Number) tp).intValue();
                } else {
                    try {
                        totalPoints = Integer.parseInt(String.valueOf(tp).split("\\.")[0]);
                    } catch (Exception e) {
                        totalPoints = 0;
                    }
                }
            }
            
            if (onLoginSuccess != null) {
                onLoginSuccess.accept(username, totalPoints);
            }
        } else {
            showError(String.valueOf(payload.get("message")));
        }
    }

    private void showError(String message) {
        new Alert(Alert.AlertType.ERROR, message).showAndWait();
    }
}
</file>

<file path="client/src/main/java/com/ltm/game/client/controllers/ResultController.java">
package com.ltm.game.client.controllers;

import com.ltm.game.client.services.AudioService;
import javafx.fxml.FXML;
import javafx.scene.control.Label;

import java.util.Map;
import java.util.function.Consumer;

public class ResultController {
    @FXML
    private Label resultIcon;
    
    @FXML
    private Label resultTitle;
    
    @FXML
    private Label yourNameLabel;
    
    @FXML
    private Label yourScoreLabel;
    
    @FXML
    private Label oppNameLabel;
    
    @FXML
    private Label oppScoreLabel;
    
    @FXML
    private Label reasonLabel;

    private Consumer<Void> onBackToLobby;
    private Consumer<Void> onShowLeaderboard;
    private AudioService audioService;

    public void setAudioService(AudioService service) {
        this.audioService = service;
    }

    public void setOnBackToLobby(Consumer<Void> callback) {
        this.onBackToLobby = callback;
    }

    public void setOnShowLeaderboard(Consumer<Void> callback) {
        this.onShowLeaderboard = callback;
    }

    public void setGameResult(Map<?, ?> payload, String myUsername) {
        if (audioService != null) {
            audioService.playCelebrationSound();
        }

        String reason = String.valueOf(payload.get("reason"));
        Map<?, ?> scores = (Map<?, ?>) payload.get("scores");
        
        int myScore = 0;
        int opponentScore = 0;
        String opponentName = "";
        
        for (var entry : scores.entrySet()) {
            String player = String.valueOf(entry.getKey());
            int score = ((Number) entry.getValue()).intValue();
            if (player.equals(myUsername)) {
                myScore = score;
            } else {
                opponentName = player;
                opponentScore = score;
            }
        }
        
        boolean isWinner = myScore > opponentScore;
        boolean isDraw = myScore == opponentScore;
        
        if (isDraw) {
            resultIcon.setText("ü§ù");
            resultTitle.setText("H√íA!");
            resultTitle.setStyle(resultTitle.getStyle() + "-fx-text-fill: #f39c12;");
        } else if (isWinner) {
            resultIcon.setText("üèÜ");
            resultTitle.setText("CHI·∫æN TH·∫ÆNG!");
            resultTitle.setStyle(resultTitle.getStyle() + "-fx-text-fill: #2ecc71;");
        } else {
            resultIcon.setText("üò¢");
            resultTitle.setText("THUA R·ªíI!");
            resultTitle.setStyle(resultTitle.getStyle() + "-fx-text-fill: #e74c3c;");
        }
        
        yourNameLabel.setText(myUsername);
        yourScoreLabel.setText(String.valueOf(myScore));
        
        String scoreColor = isWinner ? "#2ecc71" : (isDraw ? "#f39c12" : "#e74c3c");
        yourScoreLabel.setStyle(yourScoreLabel.getStyle() + "-fx-text-fill: " + scoreColor + ";");
        
        oppNameLabel.setText(opponentName);
        oppScoreLabel.setText(String.valueOf(opponentScore));
        
        String oppScoreColor = !isWinner ? "#2ecc71" : (isDraw ? "#f39c12" : "#e74c3c");
        oppScoreLabel.setStyle(oppScoreLabel.getStyle() + "-fx-text-fill: " + oppScoreColor + ";");
        
        String reasonText = "";
        if (reason.equals("all-found")) {
            reasonText = "üéØ T·∫•t c·∫£ ƒëi·ªÉm kh√°c bi·ªát ƒë√£ ƒë∆∞·ª£c t√¨m th·∫•y!";
        } else if (reason.equals("quit")) {
            reasonText = "üëã ƒê·ªëi th·ªß ƒë√£ r·ªùi kh·ªèi tr·∫≠n ƒë·∫•u";
        } else {
            reasonText = "‚úÖ Tr·∫≠n ƒë·∫•u k·∫øt th√∫c";
        }
        
        reasonLabel.setText(reasonText);
    }

    @FXML
    private void handleBackToLobby() {
        if (onBackToLobby != null) {
            onBackToLobby.accept(null);
        }
    }

    @FXML
    private void handleViewLeaderboard() {
        if (onShowLeaderboard != null) {
            onShowLeaderboard.accept(null);
        }
    }
}
</file>

<file path="client/src/main/java/com/ltm/game/client/models/LobbyUserRow.java">
package com.ltm.game.client.models;

import javafx.beans.property.SimpleStringProperty;
import javafx.beans.property.StringProperty;

public class LobbyUserRow {
    private final SimpleStringProperty username = new SimpleStringProperty("");
    private final SimpleStringProperty totalPoints = new SimpleStringProperty("");
    private final SimpleStringProperty status = new SimpleStringProperty("");

    public LobbyUserRow(String username, String totalPoints, String status) {
        this.username.set(username);
        this.totalPoints.set(totalPoints);
        this.status.set(status);
    }

    public String getUsername() { 
        return username.get(); 
    }
    
    public StringProperty usernameProperty() { 
        return username; 
    }

    public String getTotalPoints() { 
        return totalPoints.get(); 
    }
    
    public StringProperty totalPointsProperty() { 
        return totalPoints; 
    }

    public String getStatus() { 
        return status.get(); 
    }
    
    public StringProperty statusProperty() { 
        return status; 
    }
}
</file>

<file path="client/src/main/java/com/ltm/game/client/services/AudioService.java">
package com.ltm.game.client.services;

import javafx.scene.media.AudioClip;

public class AudioService {
    private AudioClip backgroundMusic;
    private AudioClip gameMusic;
    private AudioClip correctSound;
    private AudioClip wrongSound;
    private AudioClip celebrationSound;

    public void playBackgroundMusic() {
        stopBackgroundMusic();
        try {
            String musicPath = getClass().getResource("/sounds/y_ke_que.mp3").toExternalForm();
            backgroundMusic = new AudioClip(musicPath);
            backgroundMusic.setCycleCount(AudioClip.INDEFINITE);
            backgroundMusic.setVolume(0.3);
            backgroundMusic.play();
            System.out.println("Playing background music: " + musicPath);
        } catch (Exception e) {
            System.out.println("Could not load background music: " + e.getMessage());
        }
    }

    public void stopBackgroundMusic() {
        if (backgroundMusic != null) {
            backgroundMusic.stop();
        }
    }

    public void playGameMusic() {
        stopGameMusic();
        try {
            String musicPath = getClass().getResource("/sounds/nhac_ingame.mp3").toExternalForm();
            gameMusic = new AudioClip(musicPath);
            gameMusic.setCycleCount(AudioClip.INDEFINITE);
            gameMusic.setVolume(0.25);
            gameMusic.play();
            System.out.println("Playing game music: " + musicPath);
        } catch (Exception e) {
            System.out.println("Could not load game music: " + e.getMessage());
        }
    }

    public void stopGameMusic() {
        if (gameMusic != null) {
            gameMusic.stop();
        }
    }

    public void loadGameSounds() {
        try {
            String correctPath = getClass().getResource("/sounds/ye_ƒëoan_dung_roi.mp3").toExternalForm();
            correctSound = new AudioClip(correctPath);
            correctSound.setVolume(0.6);
            System.out.println("Loaded correct sound: " + correctPath);
        } catch (Exception e) {
            System.out.println("Could not load correct sound: " + e.getMessage());
        }

        try {
            String wrongPath = getClass().getResource("/sounds/phai_chiu.mp3").toExternalForm();
            wrongSound = new AudioClip(wrongPath);
            wrongSound.setVolume(0.5);
            System.out.println("Loaded wrong sound: " + wrongPath);
        } catch (Exception e) {
            System.out.println("Could not load wrong sound: " + e.getMessage());
        }
    }

    public void playCorrectSound() {
        if (correctSound != null) {
            correctSound.play();
        }
    }

    public void playWrongSound() {
        if (wrongSound != null) {
            wrongSound.play();
        }
    }

    public void playCelebrationSound() {
        try {
            String soundPath = getClass().getResource("/sounds/ving_quang.mp3").toExternalForm();
            celebrationSound = new AudioClip(soundPath);
            celebrationSound.setVolume(0.2);
            celebrationSound.play();
            System.out.println("Playing celebration sound: " + soundPath);
        } catch (Exception e) {
            System.err.println("Error playing celebration sound: " + e.getMessage());
        }
    }

    public void stopAll() {
        stopBackgroundMusic();
        stopGameMusic();
    }
}
</file>

<file path="client/src/main/java/com/ltm/game/client/services/NetworkClient.java">
package com.ltm.game.client.services;

import com.ltm.game.shared.Message;
import javafx.application.Platform;

import java.io.*;
import java.net.Socket;
import java.nio.charset.StandardCharsets;
import java.util.Map;
import java.util.Properties;
import java.util.concurrent.ConcurrentHashMap;
import java.util.function.Consumer;

public class NetworkClient {
    private final Consumer<Message> onMessage;
    private PrintWriter out;
    private Socket socket;
    private BufferedReader reader;
    private final Map<String, Consumer<Message>> handlers = new ConcurrentHashMap<>();

    public NetworkClient(Consumer<Message> onMessage) {
        this.onMessage = onMessage;
    }

    public void connect() {
        try {
            Properties props = new Properties();
            try (InputStream in = getClass().getClassLoader().getResourceAsStream("client-config.properties")) {
                if (in != null) props.load(in);
            }
            
            String host = System.getenv("SERVER_HOST");
            if (host == null) {
                host = props.getProperty("server.host", "127.0.0.1");
            }
            
            String portStr = System.getenv("SERVER_PORT");
            int port;
            if (portStr != null) {
                port = Integer.parseInt(portStr);
            } else {
                port = Integer.parseInt(props.getProperty("server.port", "5050"));
            }
            
            socket = new Socket(host, port);
            out = new PrintWriter(new BufferedWriter(new OutputStreamWriter(socket.getOutputStream(), StandardCharsets.UTF_8)), true);
            reader = new BufferedReader(new InputStreamReader(socket.getInputStream(), StandardCharsets.UTF_8));
            
            Thread t = new Thread(() -> {
                try {
                    String line;
                    while ((line = reader.readLine()) != null) {
                        Message msg = Message.fromJson(line);
                        Consumer<Message> handler = handlers.get(msg.type);
                        if (handler != null) {
                            handler.accept(msg);
                        } else {
                            onMessage.accept(msg);
                        }
                    }
                } catch (Exception e) {
                    Platform.runLater(() -> System.err.println("Disconnected: " + e.getMessage()));
                }
            }, "net-reader");
            t.setDaemon(true);
            t.start();
        } catch (Exception e) {
            throw new RuntimeException("Cannot connect to server: " + e.getMessage(), e);
        }
    }

    public void send(Message msg) {
        out.println(msg.toJson());
    }

    public void addHandler(String type, Consumer<Message> handler) {
        handlers.put(type, handler);
    }

    public void disconnect() {
        try { if (reader != null) reader.close(); } catch (Exception ignored) {}
        try { if (out != null) out.close(); } catch (Exception ignored) {}
        try { if (socket != null) socket.close(); } catch (Exception ignored) {}
    }
}
</file>

<file path="client/src/main/java/com/ltm/game/client/views/GameView.java">
package com.ltm.game.client.views;

import com.ltm.game.client.services.AudioService;
import javafx.animation.KeyFrame;
import javafx.animation.Timeline;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.canvas.Canvas;
import javafx.scene.canvas.GraphicsContext;
import javafx.scene.control.Label;
import javafx.scene.image.Image;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.scene.text.Font;
import javafx.scene.text.FontWeight;
import javafx.util.Duration;

import java.io.ByteArrayInputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.function.BiConsumer;

public class GameView {
    private final BorderPane root = new BorderPane();
    private final Canvas canvas = new Canvas(900, 450);
    private final Label scoreLabel = new Label("ƒêi·ªÉm s·ªë");
    private final Label timerLabel = new Label("‚è± 15s");
    private final Label turnLabel = new Label("L∆∞·ª£t c·ªßa b·∫°n");
    
    private AudioService audioService;
    private String nextTurn = "";
    private int scoreA = 0, scoreB = 0;
    private String playerA = "";
    private String playerB = "";
    private String myUsername = "";
    private int remainingSeconds = 15;
    private Timeline countdownTimer;
    private final List<Map<String,Object>> found = new ArrayList<>();
    private Double lastClickX = null;
    private Double lastClickY = null;
    private boolean justClicked = false;
    
    private Image leftImg;
    private Image rightImg;
    private int imgW = 300;
    private int imgH = 300;
    private final double boxX1 = 50, boxY = 80, boxX2 = 500, boxSize = 350;

    public GameView(BiConsumer<Double, Double> onClick, String myUsername, AudioService audioService) {
        this.myUsername = myUsername;
        this.audioService = audioService;
        
        if (audioService != null) {
            audioService.playGameMusic();
            audioService.loadGameSounds();
        }
        
        root.setStyle(
            "-fx-background-color: linear-gradient(to bottom right, #0f2027, #203a43, #2c5364);"
        );
        
        VBox topPanel = new VBox(8);
        topPanel.setPadding(new Insets(20, 25, 15, 25));
        topPanel.setAlignment(Pos.CENTER);
        topPanel.setStyle(
            "-fx-background-color: rgba(255, 255, 255, 0.12);" +
            "-fx-background-radius: 15px;" +
            "-fx-border-color: rgba(255, 255, 255, 0.2);" +
            "-fx-border-width: 1px;" +
            "-fx-border-radius: 15px;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.4), 12, 0.6, 0, 3);"
        );
        
        Label titleLabel = new Label("üéØ T√åM ƒêI·ªÇM KH√ÅC BI·ªÜT");
        titleLabel.setStyle(
            "-fx-font-size: 26px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: linear-gradient(to right, #a8edea, #fed6e3);" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.6), 4, 0.6, 0, 2);"
        );
        
        scoreLabel.setStyle(
            "-fx-font-size: 17px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: #ffeaa7;" +
            "-fx-effect: dropshadow(gaussian, rgba(255,234,167,0.5), 3, 0.6, 0, 1);"
        );
        
        topPanel.getChildren().addAll(titleLabel, scoreLabel);
        
        VBox centerContainer = new VBox();
        centerContainer.setAlignment(Pos.CENTER);
        centerContainer.setPadding(new Insets(15));
        centerContainer.getChildren().add(canvas);
        
        HBox bottomPanel = new HBox(40);
        bottomPanel.setPadding(new Insets(15, 25, 20, 25));
        bottomPanel.setAlignment(Pos.CENTER);
        bottomPanel.setStyle(
            "-fx-background-color: rgba(255, 255, 255, 0.12);" +
            "-fx-background-radius: 15px;" +
            "-fx-border-color: rgba(255, 255, 255, 0.2);" +
            "-fx-border-width: 1px;" +
            "-fx-border-radius: 15px;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.4), 12, 0.6, 0, 3);"
        );
        
        turnLabel.setStyle(
            "-fx-font-size: 19px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: white;" +
            "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.6), 3, 0.6, 0, 2);"
        );
        
        timerLabel.setStyle(
            "-fx-font-size: 22px;" +
            "-fx-font-weight: bold;" +
            "-fx-text-fill: #fff;" +
            "-fx-padding: 8px 20px;" +
            "-fx-background-color: rgba(255, 107, 107, 0.25);" +
            "-fx-background-radius: 25px;" +
            "-fx-border-color: rgba(255, 107, 107, 0.5);" +
            "-fx-border-width: 2px;" +
            "-fx-border-radius: 25px;" +
            "-fx-effect: dropshadow(gaussian, rgba(255,107,107,0.6), 5, 0.7, 0, 2);"
        );
        
        bottomPanel.getChildren().addAll(turnLabel, timerLabel);
        
        root.setTop(topPanel);
        root.setCenter(centerContainer);
        root.setBottom(bottomPanel);
        root.setPadding(new Insets(10));
        
        countdownTimer = new Timeline(new KeyFrame(Duration.seconds(1), e -> {
            if (remainingSeconds > 0) {
                remainingSeconds--;
                updateTimerDisplay();
            }
        }));
        countdownTimer.setCycleCount(Timeline.INDEFINITE);
        
        drawBase();
        canvas.setOnMouseClicked(e -> {
            double x = e.getX();
            double y = e.getY();
            System.out.println("Canvas clicked at: (" + x + ", " + y + ")");
            Double mappedX = null, mappedY = null;
            if (x >= boxX1 && x <= boxX1 + boxSize && y >= boxY && y <= boxY + boxSize) {
                double lx = x - boxX1; double ly = y - boxY;
                mappedX = lx * (imgW / boxSize);
                mappedY = ly * (imgH / boxSize);
                System.out.println("Left box clicked - mapped to image coords: (" + mappedX + ", " + mappedY + ")");
            } else if (x >= boxX2 && x <= boxX2 + boxSize && y >= boxY && y <= boxY + boxSize) {
                double rx = x - boxX2; double ry = y - boxY;
                mappedX = rx * (imgW / boxSize);
                mappedY = ry * (imgH / boxSize);
                System.out.println("Right box clicked - mapped to image coords: (" + mappedX + ", " + mappedY + ")");
            }
            if (mappedX != null) {
                System.out.println("Sending onClick callback with coords: (" + mappedX + ", " + mappedY + ")");
                lastClickX = mappedX;
                lastClickY = mappedY;
                justClicked = true;
                render();
                onClick.accept(mappedX, mappedY);
            } else {
                System.out.println("Click outside image boxes - ignoring");
            }
        });
    }

    private void drawBase() {
        GraphicsContext g = canvas.getGraphicsContext2D();
        
        g.setFill(Color.WHITE);
        g.fillRect(0, 0, 900, 450);
        
        g.setFill(Color.web("#e0e0e0"));
        g.fillRect(boxX1 - 5, boxY - 5, boxSize + 10, boxSize + 10);
        g.fillRect(boxX2 - 5, boxY - 5, boxSize + 10, boxSize + 10);
        
        if (leftImg != null) {
            g.drawImage(leftImg, boxX1, boxY, boxSize, boxSize);
        } else { 
            g.setFill(Color.web("#f5f5f5")); 
            g.fillRect(boxX1, boxY, boxSize, boxSize);
        }
        if (rightImg != null) {
            g.drawImage(rightImg, boxX2, boxY, boxSize, boxSize);
        } else { 
            g.setFill(Color.web("#f5f5f5")); 
            g.fillRect(boxX2, boxY, boxSize, boxSize);
        }
        
        g.setStroke(Color.web("#333333"));
        g.setLineWidth(3);
        g.strokeRect(boxX1, boxY, boxSize, boxSize);
        g.strokeRect(boxX2, boxY, boxSize, boxSize);
        g.setLineWidth(1);
        
        g.setFill(Color.web("#333333"));
        g.setFont(Font.font("System", FontWeight.BOLD, 18));
        g.fillText("·∫¢NH G·ªêC", boxX1 + boxSize/2 - 35, boxY - 12);
        g.fillText("·∫¢NH SAI KH√ÅC", boxX2 + boxSize/2 - 55, boxY - 12);
    }

    public void updateFromPayload(Map<?,?> p) {
        String oldNextTurn = nextTurn;
        
        Object scoresObj = p.get("scores");
        if (scoresObj instanceof Map<?,?> s) {
            var entries = new ArrayList<>(s.entrySet());
            if (entries.size() >= 2) {
                var e1 = (Map.Entry<?,?>) entries.get(0);
                var e2 = (Map.Entry<?,?>) entries.get(1);
                playerA = String.valueOf(e1.getKey());
                playerB = String.valueOf(e2.getKey());
                scoreA = ((Number)e1.getValue()).intValue();
                scoreB = ((Number)e2.getValue()).intValue();
            }
        }
        
        String newNextTurn = p.get("nextTurn") != null ? String.valueOf(p.get("nextTurn")) : nextTurn;
        boolean turnChanged = !oldNextTurn.isEmpty() && !newNextTurn.equals(oldNextTurn);
        
        nextTurn = newNextTurn;
        
        if (p.get("remainingTurnMs") != null) {
            long ms = ((Number)p.get("remainingTurnMs")).longValue();
            remainingSeconds = (int) Math.max(0, ms / 1000);
            
            countdownTimer.stop();
            if (remainingSeconds > 0) {
                countdownTimer.playFromStart();
            }
            updateTimerDisplay();
        }
        
        if (p.get("found") instanceof List<?> f) {
            int oldFoundCount = found.size();
            found.clear();
            lastClickX = null;
            lastClickY = null;
            
            Map<String,Object> latestFind = null;
            for (Object o: f) {
                if (o instanceof Map<?,?> m) {
                    @SuppressWarnings("unchecked")
                    Map<String,Object> findMap = (Map<String,Object>) m;
                    found.add(findMap);
                    latestFind = findMap;
                }
            }
            
            if (found.size() > oldFoundCount && latestFind != null) {
                String finder = latestFind.get("finder") != null ? String.valueOf(latestFind.get("finder")) : "";
                if (finder.equals(myUsername) && audioService != null) {
                    audioService.playCorrectSound();
                    System.out.println("Playing correct sound - player found a difference!");
                }
                justClicked = false;
            } else if (justClicked && found.size() == oldFoundCount) {
                if (audioService != null) {
                    audioService.playWrongSound();
                    System.out.println("Playing wrong sound - clicked but missed!");
                }
                justClicked = false;
            } else if (turnChanged) {
                justClicked = false;
            }
        }
        render();
    }
    
    private void updateTimerDisplay() {
        boolean isMyTurn = nextTurn.equals(myUsername);
        
        if (isMyTurn) {
            turnLabel.setText("‚ö° L∆Ø·ª¢T C·ª¶A B·∫†N ‚ö°");
            turnLabel.setStyle(
                "-fx-font-size: 20px;" +
                "-fx-font-weight: bold;" +
                "-fx-text-fill: #00ff88;" +
                "-fx-effect: dropshadow(gaussian, rgba(0,255,136,0.8), 6, 0.8, 0, 0);"
            );
            
            String timerColor = remainingSeconds <= 5 ? "#ff3838" : "#ffeaa7";
            String glowColor = remainingSeconds <= 5 ? "rgba(255,56,56,0.7)" : "rgba(255,234,167,0.5)";
            
            timerLabel.setStyle(
                "-fx-font-size: 24px;" +
                "-fx-font-weight: bold;" +
                "-fx-text-fill: " + timerColor + ";" +
                "-fx-padding: 10px 22px;" +
                "-fx-background-color: rgba(255, 255, 255, 0.15);" +
                "-fx-background-radius: 30px;" +
                "-fx-border-color: " + timerColor + ";" +
                "-fx-border-width: 2px;" +
                "-fx-border-radius: 30px;" +
                "-fx-effect: dropshadow(gaussian, " + glowColor + ", 8, 0.8, 0, 2);"
            );
        } else {
            turnLabel.setText("‚è≥ ƒê·ª£i ƒë·ªëi th·ªß...");
            turnLabel.setStyle(
                "-fx-font-size: 19px;" +
                "-fx-font-weight: bold;" +
                "-fx-text-fill: #95a5a6;" +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.6), 3, 0.6, 0, 2);"
            );
            timerLabel.setStyle(
                "-fx-font-size: 22px;" +
                "-fx-font-weight: bold;" +
                "-fx-text-fill: #bdc3c7;" +
                "-fx-padding: 8px 20px;" +
                "-fx-background-color: rgba(255, 255, 255, 0.08);" +
                "-fx-background-radius: 25px;" +
                "-fx-border-color: rgba(189, 195, 199, 0.3);" +
                "-fx-border-width: 2px;" +
                "-fx-border-radius: 25px;" +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 4, 0.5, 0, 1);"
            );
        }
        
        timerLabel.setText(String.format("‚è± %ds", remainingSeconds));
    }

    private void render() {
        drawBase();
        GraphicsContext g = canvas.getGraphicsContext2D();
        
        for (Map<String,Object> d : found) {
            double x = ((Number)d.get("x")).doubleValue();
            double y = ((Number)d.get("y")).doubleValue();
            double r = ((Number)d.get("radius")).doubleValue();
            double sx = x * (boxSize / imgW);
            double sy = y * (boxSize / imgH);
            double rr = r * (boxSize / imgW);
            
            String finder = d.get("finder") != null ? String.valueOf(d.get("finder")) : "";
            Color circleColor;
            if (finder.equals(myUsername)) {
                circleColor = Color.web("#00ff88");
            } else if (finder.equals(playerA) || finder.equals(playerB)) {
                circleColor = Color.web("#ff3838");
            } else {
                circleColor = Color.ORANGE;
            }
            
            g.setStroke(circleColor.deriveColor(0, 1, 1, 0.15));
            g.setLineWidth(14);
            g.strokeOval(boxX1 + sx - rr - 5, boxY + sy - rr - 5, rr*2 + 10, rr*2 + 10);
            g.strokeOval(boxX2 + sx - rr - 5, boxY + sy - rr - 5, rr*2 + 10, rr*2 + 10);
            
            g.setStroke(circleColor.deriveColor(0, 1, 1, 0.4));
            g.setLineWidth(8);
            g.strokeOval(boxX1 + sx - rr - 2, boxY + sy - rr - 2, rr*2 + 4, rr*2 + 4);
            g.strokeOval(boxX2 + sx - rr - 2, boxY + sy - rr - 2, rr*2 + 4, rr*2 + 4);
            
            g.setStroke(circleColor);
            g.setLineWidth(5);
            g.strokeOval(boxX1 + sx - rr, boxY + sy - rr, rr*2, rr*2);
            g.strokeOval(boxX2 + sx - rr, boxY + sy - rr, rr*2, rr*2);
            g.setLineWidth(1);
        }
        
        if (lastClickX != null && lastClickY != null) {
            double sx = lastClickX * (boxSize / imgW);
            double sy = lastClickY * (boxSize / imgH);
            g.setStroke(Color.YELLOW);
            g.setLineWidth(3);
            double crossSize = 12;
            g.strokeLine(boxX1 + sx - crossSize, boxY + sy - crossSize, boxX1 + sx + crossSize, boxY + sy + crossSize);
            g.strokeLine(boxX1 + sx + crossSize, boxY + sy - crossSize, boxX1 + sx - crossSize, boxY + sy + crossSize);
            g.strokeLine(boxX2 + sx - crossSize, boxY + sy - crossSize, boxX2 + sx + crossSize, boxY + sy + crossSize);
            g.strokeLine(boxX2 + sx + crossSize, boxY + sy - crossSize, boxX2 + sx - crossSize, boxY + sy + crossSize);
            g.setLineWidth(1);
        }
        
        String myScore = "", opponentScore = "";
        if (playerA.equals(myUsername)) {
            myScore = playerA + ": " + scoreA;
            opponentScore = playerB + ": " + scoreB;
        } else if (playerB.equals(myUsername)) {
            myScore = playerB + ": " + scoreB;
            opponentScore = playerA + ": " + scoreA;
        } else {
            myScore = "B·∫°n: ?";
            opponentScore = "ƒê·ªëi th·ªß: ?";
        }
        
        String scoreText = String.format("üë§ %s  |  üéØ %s", myScore, opponentScore);
        scoreLabel.setText(scoreText);
    }

    public BorderPane getRoot() { 
        return root; 
    }

    public void setImages(byte[] leftBytes, byte[] rightBytes, int width, int height) {
        System.out.println("GameView.setImages called: leftBytes=" + (leftBytes != null ? leftBytes.length : "null") + ", rightBytes=" + (rightBytes != null ? rightBytes.length : "null") + ", w=" + width + ", h=" + height);
        this.imgW = width > 0 ? width : this.imgW;
        this.imgH = height > 0 ? height : this.imgH;
        try {
            this.leftImg = leftBytes != null ? new Image(new ByteArrayInputStream(leftBytes)) : null;
            this.rightImg = rightBytes != null ? new Image(new ByteArrayInputStream(rightBytes)) : null;
            System.out.println("Images created: leftImg=" + (leftImg != null) + ", rightImg=" + (rightImg != null));
            if (leftImg != null) System.out.println("Left image size: " + leftImg.getWidth() + "x" + leftImg.getHeight());
            if (rightImg != null) System.out.println("Right image size: " + rightImg.getWidth() + "x" + rightImg.getHeight());
        } catch (Exception e) {
            System.err.println("Error creating Image from bytes: " + e.getMessage());
            e.printStackTrace();
        }
        render();
    }
}
</file>

<file path="client/src/main/java/com/ltm/game/client/ClientApp.java">
package com.ltm.game.client;

import com.ltm.game.shared.Message;
import com.ltm.game.shared.Protocol;
import com.ltm.game.client.controllers.*;
import com.ltm.game.client.services.AudioService;
import com.ltm.game.client.services.NetworkClient;
import com.ltm.game.client.views.GameView;
import javafx.application.Application;
import javafx.application.Platform;
import javafx.fxml.FXMLLoader;
import javafx.geometry.Rectangle2D;
import javafx.scene.Scene;
import javafx.stage.Screen;
import javafx.stage.Stage;

import java.util.List;
import java.util.Map;

public class ClientApp extends Application {
    private Stage stage;
    private NetworkClient networkClient;
    private AudioService audioService;
    
    private String username;
    private int totalPoints;
    private String currentRoomId;
    
    private LoginController loginController;
    private LobbyController lobbyController;
    private GameView gameView;
    private ResultController resultController;
    private LeaderboardController leaderboardController;
    
    private List<Map<String, Object>> pendingLobbyList;

    public static void main(String[] args) {
        launch(args);
    }

    @Override
    public void start(Stage primaryStage) {
        this.stage = primaryStage;
        this.audioService = new AudioService();
        this.networkClient = new NetworkClient(this::onMessage);
        networkClient.connect();
        
        stage.setTitle("Spot The Difference");
        
        Rectangle2D screenBounds = Screen.getPrimary().getVisualBounds();
        stage.setX(screenBounds.getMinX());
        stage.setY(screenBounds.getMinY());
        stage.setWidth(screenBounds.getWidth());
        stage.setHeight(screenBounds.getHeight());
        
        showLogin();
        stage.show();
    }

    private void handleLogout() {
        try {
            if (networkClient != null) {
                networkClient.disconnect();
            }
        } catch (Exception e) {
            System.err.println("Error disconnecting: " + e.getMessage());
        }
        
        this.username = null;
        this.totalPoints = 0;
        this.currentRoomId = null;
        this.pendingLobbyList = null;
        
        this.networkClient = new NetworkClient(this::onMessage);
        networkClient.connect();
        
        showLogin();
    }
    
    private void showLogin() {
        try {
            audioService.stopAll();
            
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/login.fxml"));
            Scene scene = new Scene(loader.load());
            
            loginController = loader.getController();
            loginController.setNetworkClient(networkClient);
            loginController.setOnLoginSuccess((user, points) -> {
                this.username = user;
                this.totalPoints = points;
                showLobby();
            });
            
            stage.setScene(scene);
        } catch (Exception e) {
            System.err.println("Error loading login view: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void showLobby() {
        try {
            audioService.stopGameMusic();
            audioService.playBackgroundMusic();
            
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/lobby.fxml"));
            Scene scene = new Scene(loader.load());
            
            lobbyController = loader.getController();
            lobbyController.setNetworkClient(networkClient);
            lobbyController.setUsername(username);
            lobbyController.setTotalPoints(totalPoints);
            
            lobbyController.setOnLogout(v -> {
                handleLogout();
            });
            
            lobbyController.setOnShowLeaderboard(v -> showLeaderboard());
            
            stage.setScene(scene);
            
            if (pendingLobbyList != null) {
                lobbyController.updateLobbyList(pendingLobbyList);
                pendingLobbyList = null;
            }
        } catch (Exception e) {
            System.err.println("Error loading lobby view: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void showGame() {
        audioService.stopBackgroundMusic();
        
        gameView = new GameView((x, y) -> {
            System.out.println("onClick callback triggered: x=" + x + ", y=" + y + ", currentRoomId=" + currentRoomId);
            if (currentRoomId != null) {
                System.out.println("Sending GAME_CLICK to server...");
                networkClient.send(new Message(Protocol.GAME_CLICK, Map.of("roomId", currentRoomId, "x", x, "y", y)));
            } else {
                System.err.println("currentRoomId is null - cannot send click!");
            }
        }, username, audioService);
        
        stage.setScene(new Scene(gameView.getRoot()));
    }

    private void showResult(Map<?, ?> payload) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/result.fxml"));
            Scene scene = new Scene(loader.load());
            
            resultController = loader.getController();
            resultController.setAudioService(audioService);
            resultController.setOnBackToLobby(v -> showLobby());
            resultController.setOnShowLeaderboard(v -> showLeaderboard());
            resultController.setGameResult(payload, username);
            
            stage.setScene(scene);
        } catch (Exception e) {
            System.err.println("Error loading result view: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void showLeaderboard() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/leaderboard.fxml"));
            Scene scene = new Scene(loader.load());
            
            leaderboardController = loader.getController();
            leaderboardController.setNetworkClient(networkClient);
            leaderboardController.setOnBack(v -> showLobby());
            leaderboardController.requestLeaderboardData();
            
            stage.setScene(scene);
        } catch (Exception e) {
            System.err.println("Error loading leaderboard view: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void onMessage(Message msg) {
        Platform.runLater(() -> {
            switch (msg.type) {
                case Protocol.AUTH_RESULT -> {
                    if (loginController != null) {
                        loginController.handleAuthResult((Map<?, ?>) msg.payload);
                    }
                }
                case Protocol.LOBBY_LIST -> {
                    @SuppressWarnings("unchecked")
                    List<Map<String, Object>> list = (List<Map<String, Object>>) msg.payload;
                    if (lobbyController == null) {
                        pendingLobbyList = list;
                    } else {
                        lobbyController.updateLobbyList(list);
                    }
                }
                case Protocol.INVITE_RECEIVED -> {
                    String from = String.valueOf(((Map<?, ?>) msg.payload).get("fromUser"));
                    if (lobbyController != null) {
                        lobbyController.showInviteDialog(from);
                    }
                }
                case Protocol.INVITE_RESPONSE -> {
                    boolean accepted = Boolean.parseBoolean(String.valueOf(((Map<?, ?>) msg.payload).get("accepted")));
                    if (!accepted && lobbyController != null) {
                        lobbyController.showInviteRejected();
                    }
                }
                case Protocol.GAME_START -> {
                    Map<?, ?> p = (Map<?, ?>) msg.payload;
                    currentRoomId = String.valueOf(p.get("roomId"));
                    showGame();
                    
                    try {
                        String b64L = (String) p.get("imgLeft");
                        String b64R = (String) p.get("imgRight");
                        Integer w = p.get("imageWidth") != null ? ((Number) p.get("imageWidth")).intValue() : 0;
                        Integer h = p.get("imageHeight") != null ? ((Number) p.get("imageHeight")).intValue() : 0;
                        System.out.println("GAME_START: imgLeft=" + (b64L != null ? b64L.length() : "null") + " chars, imgRight=" + (b64R != null ? b64R.length() : "null") + " chars, w=" + w + ", h=" + h);
                        byte[] leftBytes = (b64L != null) ? java.util.Base64.getDecoder().decode(b64L) : null;
                        byte[] rightBytes = (b64R != null) ? java.util.Base64.getDecoder().decode(b64R) : null;
                        System.out.println("Decoded: leftBytes=" + (leftBytes != null ? leftBytes.length : "null") + " bytes, rightBytes=" + (rightBytes != null ? rightBytes.length : "null") + " bytes");
                        if (gameView != null) {
                            gameView.setImages(leftBytes, rightBytes, w, h);
                            System.out.println("Called gameView.setImages()");
                        } else {
                            System.err.println("gameView is null!");
                        }
                    } catch (Exception e) {
                        System.err.println("Error decoding images: " + e.getMessage());
                        e.printStackTrace();
                    }
                }
                case Protocol.GAME_UPDATE -> {
                    if (gameView != null) {
                        gameView.updateFromPayload((Map<?, ?>) msg.payload);
                    }
                }
                case Protocol.GAME_END -> {
                    if (gameView != null) {
                        gameView.updateFromPayload((Map<?, ?>) msg.payload);
                    }
                    showResult((Map<?, ?>) msg.payload);
                }
                case Protocol.ERROR -> {
                    String errorMsg = msg.payload != null ? String.valueOf(((Map<?, ?>) msg.payload).get("message")) : "Unknown error";
                    System.out.println("Error from server: " + errorMsg);
                }
            }
        });
    }
}
</file>

<file path="client/src/main/resources/fxml/leaderboard.fxml">
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<VBox xmlns="http://javafx.com/javafx"
      xmlns:fx="http://javafx.com/fxml"
      fx:controller="com.ltm.game.client.controllers.LeaderboardController"
      spacing="0"
      style="-fx-background-color: linear-gradient(to bottom, #0a1929, #1a2f4a); -fx-padding: 0;">
    
    <VBox alignment="CENTER" spacing="12"
          style="-fx-background-color: linear-gradient(to bottom, rgba(30,144,255,0.3), rgba(0,0,0,0.1)); -fx-border-color: rgba(255,255,255,0.1); -fx-border-width: 0 0 2 0;">
        <padding>
            <Insets top="20" right="15" bottom="18" left="15"/>
        </padding>
        
        <Label text="B·∫¢NG X·∫æP H·∫†NG"
               style="-fx-font-size: 24px; -fx-font-weight: bold; -fx-text-fill: white; -fx-background-color: #1e5a9e; -fx-padding: 8px 35px; -fx-background-radius: 12px; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.6), 8, 0.6, 0, 3);"/>
        
        <Button text="‚¨Ö Quay l·∫°i"
                onAction="#handleBack"
                style="-fx-font-size: 13px; -fx-padding: 6px 18px; -fx-background-color: #7f8c8d; -fx-text-fill: white; -fx-background-radius: 5px; -fx-cursor: hand; -fx-font-weight: bold;"/>
    </VBox>
    
    <ScrollPane fitToWidth="true"
                VBox.vgrow="ALWAYS"
                style="-fx-background-color: transparent; -fx-background: transparent;"
                hbarPolicy="NEVER"
                vbarPolicy="AS_NEEDED">
        <StackPane alignment="TOP_CENTER">
            <VBox fx:id="entriesContainer"
                  spacing="8"
                  alignment="TOP_CENTER"
                  maxWidth="700">
                <padding>
                    <Insets top="18" right="20" bottom="18" left="20"/>
                </padding>
            </VBox>
        </StackPane>
    </ScrollPane>
</VBox>
</file>

<file path="client/src/main/resources/fxml/lobby.fxml">
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<BorderPane fx:id="rootPane"
            xmlns="http://javafx.com/javafx"
            xmlns:fx="http://javafx.com/fxml"
            fx:controller="com.ltm.game.client.controllers.LobbyController"
            style="-fx-background-color: linear-gradient(to bottom right, #2c3e50, #3498db);">
    
    <padding>
        <Insets top="20" right="20" bottom="20" left="20"/>
    </padding>
    
    <top>
        <HBox alignment="CENTER_LEFT" spacing="10"
              style="-fx-background-color: rgba(41, 128, 185, 0.85); -fx-background-radius: 15px; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.4), 10, 0.6, 0, 3);">
            <padding>
                <Insets top="20" right="20" bottom="20" left="20"/>
            </padding>
            
            <Label fx:id="headerUserInfo"
                   style="-fx-font-size: 16px; -fx-font-weight: bold; -fx-text-fill: white; -fx-effect: dropshadow(gaussian, black, 3, 0.5, 0, 0);"/>
            
            <Button text="üö™ Tho√°t"
                    onAction="#handleLogout"
                    style="-fx-font-size: 14px; -fx-padding: 8px 20px; -fx-background-color: #e74c3c; -fx-text-fill: white; -fx-background-radius: 5px; -fx-cursor: hand; -fx-font-weight: bold;"/>
        </HBox>
    </top>
    
    <center>
        <VBox spacing="15">
            <padding>
                <Insets top="10" right="10" bottom="10" left="10"/>
            </padding>
            
            <HBox alignment="CENTER_LEFT" spacing="15"
                  style="-fx-background-color: rgba(52, 152, 219, 0.3); -fx-background-radius: 10px; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 8, 0.4, 0, 2);">
                <padding>
                    <Insets top="15" right="15" bottom="15" left="15"/>
                </padding>
                
                <TextField fx:id="searchField"
                           promptText="üîç T√¨m ng∆∞·ªùi ch∆°i..."
                           prefHeight="40"
                           HBox.hgrow="ALWAYS"
                           style="-fx-font-size: 14px; -fx-padding: 10px 15px; -fx-background-radius: 20px; -fx-background-color: rgba(255, 255, 255, 0.9); -fx-border-color: #3498db; -fx-border-radius: 20px; -fx-border-width: 2px; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 5, 0.3, 0, 1);"/>
                
                <CheckBox fx:id="autoRefresh"
                          text="üîÑ Refresh t·ª± ƒë·ªông"
                          style="-fx-text-fill: white; -fx-font-size: 14px; -fx-font-weight: bold; -fx-effect: dropshadow(gaussian, black, 2, 0.5, 0, 0);"/>
            </HBox>
            
            <TableView fx:id="lobbyTable"
                       VBox.vgrow="ALWAYS"
                       style="-fx-background-color: rgba(255, 255, 255, 0.95); -fx-background-radius: 10px; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 10, 0.5, 0, 2); -fx-font-size: 13px;">
                <placeholder>
                    <Label text="Kh√¥ng c√≥ ng∆∞·ªùi ch∆°i kh√°c ƒëang tr·ª±c tuy·∫øn."/>
                </placeholder>
                <columns>
                    <TableColumn fx:id="colUser" text="üë§ T√™n" prefWidth="150"
                                 style="-fx-alignment: CENTER-LEFT; -fx-font-weight: bold;"/>
                    <TableColumn fx:id="colPoints" text="‚≠ê T·ªïng ƒëi·ªÉm" prefWidth="120"
                                 style="-fx-alignment: CENTER; -fx-text-fill: #f39c12; -fx-font-weight: bold;"/>
                    <TableColumn fx:id="colStatus" text="üìä Tr·∫°ng th√°i" prefWidth="120"
                                 style="-fx-alignment: CENTER;"/>
                    <TableColumn fx:id="colAction" text="üéØ H√†nh ƒë·ªông" prefWidth="150"
                                 style="-fx-alignment: CENTER;"/>
                </columns>
            </TableView>
        </VBox>
    </center>
    
    <right>
        <VBox spacing="15" alignment="TOP_CENTER"
              style="-fx-background-color: rgba(44, 62, 80, 0.85); -fx-background-radius: 15px; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.4), 12, 0.6, 0, 3);">
            <padding>
                <Insets top="20" right="20" bottom="20" left="20"/>
            </padding>
            
            <Label text="üéÆ MENU"
                   style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: white; -fx-effect: dropshadow(gaussian, rgba(52,152,219,0.8), 5, 0.8, 0, 0); -fx-padding: 10px;"/>
            
            <Button text="üé≤ M·ªùi ng∆∞·ªùi l·∫° ng·∫´u nhi√™n"
                    onAction="#handleRandomInvite"
                    minWidth="200"
                    style="-fx-font-size: 14px; -fx-padding: 10px 20px; -fx-background-color: #9b59b6; -fx-text-fill: white; -fx-background-radius: 5px; -fx-cursor: hand; -fx-font-weight: bold;"/>
            
            <Button text="üèÜ Xem b·∫£ng x·∫øp h·∫°ng"
                    onAction="#handleShowLeaderboard"
                    minWidth="200"
                    style="-fx-font-size: 14px; -fx-padding: 10px 20px; -fx-background-color: #f39c12; -fx-text-fill: white; -fx-background-radius: 5px; -fx-cursor: hand; -fx-font-weight: bold;"/>
            
            <Button text="üîÑ ƒê·ªïi tr·∫°ng th√°i"
                    onAction="#handleToggleStatus"
                    minWidth="200"
                    style="-fx-font-size: 14px; -fx-padding: 10px 20px; -fx-background-color: #16a085; -fx-text-fill: white; -fx-background-radius: 5px; -fx-cursor: hand; -fx-font-weight: bold;"/>
        </VBox>
    </right>
</BorderPane>
</file>

<file path="client/src/main/resources/fxml/login.fxml">
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.image.ImageView?>
<?import javafx.scene.image.Image?>
<?import javafx.scene.effect.GaussianBlur?>

<StackPane xmlns="http://javafx.com/javafx"
           xmlns:fx="http://javafx.com/fxml"
           fx:controller="com.ltm.game.client.controllers.LoginController">
    
    <!-- Background Image -->
    <ImageView fitWidth="1920" fitHeight="1080" preserveRatio="false" pickOnBounds="true">
        <image>
            <Image url="@../images/v2/forest-8227410.jpg"/>
        </image>
    </ImageView>
    
    <!-- Dark Overlay -->
    <Pane style="-fx-background-color: rgba(0, 0, 0, 0.3);"/>
    
    <!-- Login Card with Glass Morphism -->
    <VBox alignment="CENTER" spacing="25" maxWidth="450" maxHeight="600"
          style="-fx-background-color: rgba(255, 255, 255, 0.15); 
                 -fx-background-radius: 25px; 
                 -fx-border-color: rgba(255, 255, 255, 0.3); 
                 -fx-border-width: 2px; 
                 -fx-border-radius: 25px; 
                 -fx-effect: dropshadow(gaussian, rgba(0, 0, 0, 0.5), 30, 0.5, 0, 10);">
        
        <padding>
            <Insets top="50" right="50" bottom="50" left="50"/>
        </padding>
        
        <!-- Game Icon/Logo -->
        <Label text="üå≤üéÆüå≤"
               style="-fx-font-size: 48px;"/>
        
        <!-- Title -->
        <VBox alignment="CENTER" spacing="8">
            <Label text="SPOT THE DIFFERENCE"
                   style="-fx-font-size: 36px; 
                          -fx-font-weight: bold; 
                          -fx-text-fill: white; 
                          -fx-effect: dropshadow(gaussian, rgba(34, 139, 34, 0.8), 8, 0.7, 0, 2);"/>
            
            <Label text="T√åM ƒêI·ªÇM KH√ÅC BI·ªÜT"
                   style="-fx-font-size: 18px; 
                          -fx-font-weight: bold; 
                          -fx-text-fill: rgba(144, 238, 144, 1); 
                          -fx-effect: dropshadow(gaussian, rgba(0, 0, 0, 0.6), 5, 0.5, 0, 2);"/>
        </VBox>
        
        <!-- Spacer -->
        <Region minHeight="10"/>
        
        <!-- Username Field -->
        <VBox spacing="8" maxWidth="350">
            <Label text="üë§ T√™n ƒëƒÉng nh·∫≠p"
                   style="-fx-text-fill: white; 
                          -fx-font-size: 14px; 
                          -fx-font-weight: bold; 
                          -fx-effect: dropshadow(gaussian, rgba(0, 0, 0, 0.5), 3, 0.5, 0, 1);"/>
            
            <TextField fx:id="usernameField"
                       promptText="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p..."
                       style="-fx-font-size: 15px; 
                              -fx-padding: 15px 20px; 
                              -fx-background-color: rgba(255, 255, 255, 0.9); 
                              -fx-background-radius: 15px; 
                              -fx-border-color: rgba(34, 139, 34, 0.6); 
                              -fx-border-radius: 15px; 
                              -fx-border-width: 2px; 
                              -fx-effect: dropshadow(gaussian, rgba(0, 0, 0, 0.3), 8, 0.4, 0, 2);"/>
        </VBox>
        
        <!-- Password Field -->
        <VBox spacing="8" maxWidth="350">
            <Label text="üîí M·∫≠t kh·∫©u"
                   style="-fx-text-fill: white; 
                          -fx-font-size: 14px; 
                          -fx-font-weight: bold; 
                          -fx-effect: dropshadow(gaussian, rgba(0, 0, 0, 0.5), 3, 0.5, 0, 1);"/>
            
            <PasswordField fx:id="passwordField"
                           promptText="Nh·∫≠p m·∫≠t kh·∫©u..."
                           style="-fx-font-size: 15px; 
                                  -fx-padding: 15px 20px; 
                                  -fx-background-color: rgba(255, 255, 255, 0.9); 
                                  -fx-background-radius: 15px; 
                                  -fx-border-color: rgba(34, 139, 34, 0.6); 
                                  -fx-border-radius: 15px; 
                                  -fx-border-width: 2px; 
                                  -fx-effect: dropshadow(gaussian, rgba(0, 0, 0, 0.3), 8, 0.4, 0, 2);"/>
        </VBox>
        
        <!-- Spacer -->
        <Region minHeight="5"/>
        
        <!-- Login Button -->
        <Button text="üåü ƒêƒÇNG NH·∫¨P üåü"
                onAction="#handleLogin"
                maxWidth="350"
                styleClass="login-button"
                style="-fx-font-size: 18px; 
                       -fx-font-weight: bold; 
                       -fx-padding: 16px 50px; 
                       -fx-background-color: linear-gradient(to right, #228B22, #32CD32); 
                       -fx-text-fill: white; 
                       -fx-background-radius: 15px; 
                       -fx-cursor: hand; 
                       -fx-effect: dropshadow(gaussian, rgba(34, 139, 34, 0.6), 12, 0.6, 0, 4);"/>
        
        <!-- Info Text -->
        <Label text="‚ú® Ch√†o m·ª´ng ƒë·∫øn v·ªõi tr√≤ ch∆°i! ‚ú®"
               style="-fx-text-fill: rgba(255, 255, 255, 0.9); 
                      -fx-font-size: 13px; 
                      -fx-font-style: italic; 
                      -fx-effect: dropshadow(gaussian, rgba(0, 0, 0, 0.5), 3, 0.5, 0, 1);"/>
    </VBox>
    
</StackPane>
</file>

<file path="client/src/main/resources/fxml/result.fxml">
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<VBox xmlns="http://javafx.com/javafx"
      xmlns:fx="http://javafx.com/fxml"
      fx:controller="com.ltm.game.client.controllers.ResultController"
      alignment="CENTER"
      spacing="30"
      style="-fx-background-color: linear-gradient(to bottom right, #1a1a2e, #16213e);">
    
    <padding>
        <Insets top="40" right="40" bottom="40" left="40"/>
    </padding>
    
    <VBox alignment="CENTER" spacing="15">
        <Label fx:id="resultIcon"
               style="-fx-font-size: 120px;"/>
        
        <Label fx:id="resultTitle"
               style="-fx-font-size: 48px; -fx-font-weight: bold; -fx-effect: dropshadow(gaussian, rgba(255,255,255,0.8), 15, 0.8, 0, 0);"/>
    </VBox>
    
    <HBox alignment="CENTER" spacing="40"
          style="-fx-background-color: rgba(255,255,255,0.1); -fx-background-radius: 20px; -fx-border-color: rgba(255,255,255,0.3); -fx-border-width: 2px; -fx-border-radius: 20px; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 15, 0.7, 0, 5);">
        <padding>
            <Insets top="30" right="30" bottom="30" left="30"/>
        </padding>
        
        <VBox alignment="CENTER" spacing="10">
            <Label text="B·∫†N"
                   style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: rgba(255,255,255,0.8);"/>
            
            <Label fx:id="yourNameLabel"
                   style="-fx-font-size: 24px; -fx-font-weight: bold; -fx-text-fill: white;"/>
            
            <Label fx:id="yourScoreLabel"
                   style="-fx-font-size: 64px; -fx-font-weight: bold; -fx-effect: dropshadow(gaussian, rgba(255,255,255,0.5), 10, 0.7, 0, 0);"/>
            
            <Label text="ƒëi·ªÉm"
                   style="-fx-font-size: 16px; -fx-text-fill: rgba(255,255,255,0.6);"/>
        </VBox>
        
        <Label text="VS"
               style="-fx-font-size: 32px; -fx-font-weight: bold; -fx-text-fill: rgba(255,255,255,0.5); -fx-padding: 20px 0;"/>
        
        <VBox alignment="CENTER" spacing="10">
            <Label text="ƒê·ªêI TH·ª¶"
                   style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: rgba(255,255,255,0.8);"/>
            
            <Label fx:id="oppNameLabel"
                   style="-fx-font-size: 24px; -fx-font-weight: bold; -fx-text-fill: white;"/>
            
            <Label fx:id="oppScoreLabel"
                   style="-fx-font-size: 64px; -fx-font-weight: bold; -fx-effect: dropshadow(gaussian, rgba(255,255,255,0.5), 10, 0.7, 0, 0);"/>
            
            <Label text="ƒëi·ªÉm"
                   style="-fx-font-size: 16px; -fx-text-fill: rgba(255,255,255,0.6);"/>
        </VBox>
    </HBox>
    
    <Label fx:id="reasonLabel"
           style="-fx-font-size: 18px; -fx-text-fill: rgba(255,255,255,0.8); -fx-font-style: italic; -fx-padding: 10px 30px; -fx-background-color: rgba(255,255,255,0.1); -fx-background-radius: 15px;"/>
    
    <HBox alignment="CENTER" spacing="20">
        <padding>
            <Insets top="20" right="0" bottom="0" left="0"/>
        </padding>
        
        <Button text="üè† V·ªÅ Trang Ch·ªß"
                onAction="#handleBackToLobby"
                minWidth="200"
                style="-fx-font-size: 14px; -fx-padding: 10px 20px; -fx-background-color: #3498db; -fx-text-fill: white; -fx-background-radius: 5px; -fx-cursor: hand; -fx-font-weight: bold;"/>
        
        <Button text="üèÜ Xem B·∫£ng X·∫øp H·∫°ng"
                onAction="#handleViewLeaderboard"
                minWidth="200"
                style="-fx-font-size: 14px; -fx-padding: 10px 20px; -fx-background-color: #f39c12; -fx-text-fill: white; -fx-background-radius: 5px; -fx-cursor: hand; -fx-font-weight: bold;"/>
    </HBox>
</VBox>
</file>

<file path="client/src/main/resources/sounds/README.md">
# Th∆∞ m·ª•c √¢m thanh cho game

ƒê·∫∑t c√°c file √¢m thanh v√†o ƒë√¢y. H·ªó tr·ª£ c√°c ƒë·ªãnh d·∫°ng: `.mp3`, `.wav`, `.m4a`

## C√°c √¢m thanh g·ª£i √Ω:

- `click.wav` - √Çm thanh khi click chu·ªôt
- `correct.wav` - √Çm thanh khi t√¨m ƒë√∫ng ƒëi·ªÉm kh√°c bi·ªát (hit)
- `wrong.wav` - √Çm thanh khi click sai (miss)
- `button_hover.wav` - √Çm thanh khi hover button
- `game_start.wav` - √Çm thanh khi b·∫Øt ƒë·∫ßu game
- `game_over.wav` - √Çm thanh khi k·∫øt th√∫c game
- `victory.wav` - √Çm thanh khi th·∫Øng
- `defeat.wav` - √Çm thanh khi thua
- `notification.wav` - √Çm thanh th√¥ng b√°o
- `invite.wav` - √Çm thanh khi nh·∫≠n l·ªùi m·ªùi
- `countdown.wav` - √Çm thanh ƒë·∫øm ng∆∞·ª£c (tick tock)
- `timeout.wav` - √Çm thanh h·∫øt gi·ªù

## V√≠ d·ª• load √¢m thanh trong code:

```java
// Load √¢m thanh
String soundPath = getClass().getResource("/sounds/correct.wav").toExternalForm();
AudioClip sound = new AudioClip(soundPath);

// Ph√°t √¢m thanh
sound.play();

// Ph√°t v·ªõi volume
sound.play(0.5); // 50% volume
```

## Th∆∞ vi·ªán √¢m thanh mi·ªÖn ph√≠:

- https://freesound.org/
- https://mixkit.co/free-sound-effects/
- https://www.zapsplat.com/
- https://soundbible.com/

**L∆∞u √Ω:** File √¢m thanh n√™n nh·ªè g·ªçn (< 1MB) ƒë·ªÉ load nhanh.
</file>

<file path="client/src/main/resources/client-config.properties">
server.host=127.0.0.1
server.port=5050
</file>

<file path="client/.gitignore">
target
</file>

<file path="client/Dockerfile">
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /build
COPY pom.xml ./
COPY shared ./shared
COPY client ./client
COPY server/pom.xml ./server/pom.xml
COPY admin/pom.xml ./admin/pom.xml
RUN mvn install -N -DskipTests && \
    mvn clean install -DskipTests -pl shared && \
    mvn clean package -DskipTests -pl client

FROM eclipse-temurin:17-jdk
WORKDIR /app
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libgtk-3-0 \
    libxtst6 \
    xvfb \
    && rm -rf /var/lib/apt/lists/*
COPY --from=build /build/client/target/client-0.1.0-SNAPSHOT.jar /app/client.jar
COPY --from=build /build/client/target/classes /app/classes
ENV DISPLAY=:99
CMD Xvfb :99 -screen 0 1024x768x16 & java -jar client.jar
</file>

<file path="db/schema.sql">
-- MySQL schema for Spot The Difference
CREATE DATABASE IF NOT EXISTS spotgame CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE spotgame;

CREATE TABLE IF NOT EXISTS users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  total_points INT NOT NULL DEFAULT 0,
  total_wins INT NOT NULL DEFAULT 0,
  total_losses INT NOT NULL DEFAULT 0,
  total_draws INT NOT NULL DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS matches (
  id INT AUTO_INCREMENT PRIMARY KEY,
  player_a_id INT NOT NULL,
  player_b_id INT NOT NULL,
  score_a INT NOT NULL,
  score_b INT NOT NULL,
  result ENUM('A','B','DRAW') NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (player_a_id) REFERENCES users(id),
  FOREIGN KEY (player_b_id) REFERENCES users(id)
);

CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);

-- Image sets for game content
-- Store image file paths (relative to content.dir) instead of BLOBs
CREATE TABLE IF NOT EXISTS image_sets (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  width INT NOT NULL,
  height INT NOT NULL,
  img_left_path VARCHAR(255) NOT NULL,
  img_right_path VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS image_differences (
  id INT AUTO_INCREMENT PRIMARY KEY,
  set_id INT NOT NULL,
  x INT NOT NULL,
  y INT NOT NULL,
  radius INT NOT NULL,
  FOREIGN KEY (set_id) REFERENCES image_sets(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_diffs_set ON image_differences(set_id);
</file>

<file path="db/seed.sql">
-- Seed data for Spot The Difference (plain text passwords stored in password_hash)
USE spotgame;

-- Users (plain passwords as requested)
INSERT INTO users (username, password_hash)
VALUES
  ('alice', '123456'),
  ('bob',   '123456'),
  ('carol', 'password')
ON DUPLICATE KEY UPDATE
  password_hash = VALUES(password_hash);

-- Example matches between users
INSERT INTO matches (player_a_id, player_b_id, score_a, score_b, result, created_at)
VALUES
  ((SELECT id FROM users WHERE username='alice'), (SELECT id FROM users WHERE username='bob'),   5, 3, 'A',    NOW()),
  ((SELECT id FROM users WHERE username='bob'),   (SELECT id FROM users WHERE username='carol'), 2, 2, 'DRAW', NOW()),
  ((SELECT id FROM users WHERE username='carol'), (SELECT id FROM users WHERE username='alice'), 1, 4, 'B',    NOW())
;

-- Recompute leaderboard stats based on matches
UPDATE users u
LEFT JOIN (
  SELECT player_a_id AS uid, SUM(score_a) AS pts FROM matches GROUP BY player_a_id
) a ON u.id = a.uid
LEFT JOIN (
  SELECT player_b_id AS uid, SUM(score_b) AS pts FROM matches GROUP BY player_b_id
) b ON u.id = b.uid
LEFT JOIN (
  SELECT uid,
         SUM(win)   AS wins,
         SUM(loss)  AS losses,
         SUM(draws) AS draws
  FROM (
    SELECT player_a_id AS uid,
           CASE WHEN result='A'    THEN 1 ELSE 0 END AS win,
           CASE WHEN result='B'    THEN 1 ELSE 0 END AS loss,
           CASE WHEN result='DRAW' THEN 1 ELSE 0 END AS draws
    FROM matches
    UNION ALL
    SELECT player_b_id AS uid,
           CASE WHEN result='B'    THEN 1 ELSE 0 END AS win,
           CASE WHEN result='A'    THEN 1 ELSE 0 END AS loss,
           CASE WHEN result='DRAW' THEN 1 ELSE 0 END AS draws
    FROM matches
  ) t
  GROUP BY uid
) w ON u.id = w.uid
SET u.total_points = COALESCE(a.pts,0) + COALESCE(b.pts,0),
    u.total_wins   = COALESCE(w.wins,0),
    u.total_losses = COALESCE(w.losses,0),
    u.total_draws  = COALESCE(w.draws,0);
</file>

<file path="server/src/main/java/com/ltm/game/server/ClientHandler.java">
package com.ltm.game.server;

import com.ltm.game.shared.Message;
import com.ltm.game.shared.models.LeaderboardEntry;
import java.util.List;
import java.util.ArrayList;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import com.ltm.game.shared.Protocol;
import com.google.gson.Gson;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.Socket;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.Map;

public class ClientHandler implements Runnable {
    private static final Gson GSON = new Gson();

    private final Socket socket;
    private final LobbyService lobby;
    private final GameService gameService;
    private final ClientSession session;

    public ClientHandler(Socket socket, LobbyService lobby, GameService gameService) throws Exception {
        this.socket = socket;
        this.lobby = lobby;
        this.gameService = gameService;
        this.session = new ClientSession(socket);
    }

    @Override
    public void run() {
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream(), StandardCharsets.UTF_8))) {
            String line;
            while ((line = reader.readLine()) != null) {
                Message msg = Message.fromJson(line);
                handle(msg);
            }
        } catch (Exception e) {
            // client disconnected or error
        } finally {
            if (session.username != null) {
                lobby.onDisconnect(session);
            }
            try { socket.close(); } catch (Exception ignored) {}
        }
    }

    private void handle(Message msg) {
        switch (msg.type) {
            case Protocol.AUTH_LOGIN -> onLogin(msg);
            case Protocol.INVITE_SEND -> lobby.onInviteSend(session, (Map<?,?>) msg.payload);
            case Protocol.INVITE_RESPONSE -> gameService.onInviteResponse(session, (Map<?,?>) msg.payload);
            case Protocol.GAME_CLICK -> gameService.onGameClick(session, (Map<?,?>) msg.payload);
            case Protocol.GAME_QUIT -> gameService.onGameQuit(session, (Map<?,?>) msg.payload);
            case Protocol.LEADERBOARD -> onLeaderboard();
            default -> {}
        }
    }

    private void onLogin(Message msg) {
        Map<?,?> p = (Map<?,?>) msg.payload;
        String username = String.valueOf(p.get("username"));
        String password = String.valueOf(p.get("password"));
        var result = lobby.authenticate(username, password);
        Map<String,Object> resp = new HashMap<>();
        resp.put("success", result.success);
        resp.put("message", result.message);
        resp.put("user", result.user);
        session.username = result.success ? result.user.username : null;
        session.inGame = false;
        session.send(new Message(Protocol.AUTH_RESULT, resp).toJson());
        if (result.success) {
            lobby.onLogin(session, result.user);
        }
    }

    private void onLeaderboard() {
        try {
            List<LeaderboardEntry> entries = new ArrayList<>();
            try (Connection c = Database.getConnection();
                 PreparedStatement ps = c.prepareStatement(
                     "SELECT username, total_points, total_wins FROM users " +
                     "ORDER BY total_points DESC, total_wins DESC LIMIT 100")) {
                try (ResultSet rs = ps.executeQuery()) {
                    while (rs.next()) {
                        entries.add(new LeaderboardEntry(
                            rs.getString("username"),
                            rs.getInt("total_points"),
                            rs.getInt("total_wins")
                        ));
                    }
                }
            }
            session.send(new Message(Protocol.LEADERBOARD, entries).toJson());
        } catch (Exception e) {
            System.err.println("Error getting leaderboard: " + e.getMessage());
        }
    }
}
</file>

<file path="server/src/main/java/com/ltm/game/server/ClientSession.java">
package com.ltm.game.server;

import java.io.BufferedWriter;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.net.Socket;
import java.nio.charset.StandardCharsets;

public class ClientSession {
    public final Socket socket;
    public final PrintWriter out;
    public volatile String username;
    public volatile boolean inGame = false;

    public ClientSession(Socket socket) throws Exception {
        this.socket = socket;
        this.out = new PrintWriter(new BufferedWriter(new OutputStreamWriter(socket.getOutputStream(), StandardCharsets.UTF_8)), true);
    }

    public void send(String json) {
        out.println(json);
    }
}
</file>

<file path="server/src/main/java/com/ltm/game/server/Database.java">
package com.ltm.game.server;

import java.sql.Connection;
import java.sql.DriverManager;
import java.util.Properties;

public class Database {
    private static String url;
    private static String user;
    private static String pass;
    static {
        Properties props = ServerProperties.load();
        url = props.getProperty("db.url");
        user = props.getProperty("db.user");
        pass = props.getProperty("db.password");
    }
    public static Connection getConnection() throws Exception {
        return DriverManager.getConnection(url, user, pass);
    }
}
</file>

<file path="server/src/main/java/com/ltm/game/server/GameServer.java">
package com.ltm.game.server;

import com.ltm.game.shared.Message;
import com.ltm.game.shared.Protocol;

import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.Properties;

public class GameServer {
    public static void main(String[] args) throws Exception {
        Properties props = ServerProperties.load();
        int port = Integer.parseInt(props.getProperty("server.port", "5050"));
        LobbyService lobby = new LobbyService();
        GameService gameService = new GameService(lobby, props);

        System.out.println("Server starting on port " + port);
        try (ServerSocket serverSocket = new ServerSocket(port)) {
            while (true) {
                Socket socket = serverSocket.accept();
                ClientHandler handler = new ClientHandler(socket, lobby, gameService);
                new Thread(handler, "client-" + socket.getPort()).start();
            }
        }
    }
}
</file>

<file path="server/src/main/java/com/ltm/game/server/GameService.java">
package com.ltm.game.server;

import com.ltm.game.shared.Message;
import com.ltm.game.shared.models.User;
import com.ltm.game.shared.Protocol;

import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ScheduledThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class GameService {
    private final LobbyService lobby;
    private final int turnSeconds;
    private final ScheduledThreadPoolExecutor scheduler = new ScheduledThreadPoolExecutor(2);
    private final Map<String, GameRoom> rooms = new ConcurrentHashMap<>();
    private final UserRepository userRepo = new UserRepository();
    private final MatchRepository matchRepo = new MatchRepository();
    private final ImageSetRepository imageRepo = new ImageSetRepository();

    public GameService(LobbyService lobby, java.util.Properties props) {
        this.lobby = lobby;
        this.turnSeconds = Integer.parseInt(props.getProperty("turn.seconds", "15"));
    }

    public void startGame(String userA, String userB) {
        GameRoom room;
        ImageSetRepository.ImageSet set = null;
        try {
            set = imageRepo.loadRandom();
        } catch (Exception e) {
            System.err.println("Failed to load random image set: "+e.getMessage());
        }
        if (set != null && set.diffs() != null && !set.diffs().isEmpty() && set.left() != null && set.right() != null) {
            room = new GameRoom(UUID.randomUUID().toString(), userA, userB, set.diffs());
            room.imageSetId = String.valueOf(set.id());
            room.imageWidth = set.width();
            room.imageHeight = set.height();
            room.imgLeft = set.left();
            room.imgRight = set.right();
        } else {
            room = new GameRoom(UUID.randomUUID().toString(), userA, userB, sampleDifferences());
            room.imageSetId = "builtin-1";
            room.imageWidth = 300; room.imageHeight = 300;
            room.imgLeft = null; room.imgRight = null;
        }
        rooms.put(room.id, room);
        lobby.setBusy(userA, true);
        lobby.setBusy(userB, true);
        notifyStart(room);
        scheduleTurnTimeout(room);
    }

    public void onGameClick(ClientSession session, Map<?,?> payload) {
        String roomId = String.valueOf(payload.get("roomId"));
        double x = Double.parseDouble(String.valueOf(payload.get("x")));
        double y = Double.parseDouble(String.valueOf(payload.get("y")));
        System.out.println("GAME_CLICK received: roomId=" + roomId + ", user=" + session.username + ", x=" + x + ", y=" + y);
        GameRoom room = rooms.get(roomId);
        if (room == null) {
            System.err.println("Room not found: " + roomId);
            return;
        }
        synchronized (room) {
            System.out.println("Current turn: " + room.currentTurn + ", clicking user: " + session.username);
            if (!room.currentTurn.equals(session.username)) {
                System.out.println("Not this player's turn - ignoring click");
                session.send(new Message(Protocol.ERROR, Map.of("message", "Kh√¥ng ph·∫£i l∆∞·ª£t c·ªßa b·∫°n!")).toJson());
                return;
            }
            
            // Try to find a difference at the clicked position
            boolean hit = room.tryHit(x, y, session.username);
            System.out.println("Hit result: " + hit + " at (" + x + ", " + y + ")");
            
            if (hit) {
                // Correct hit: score already updated in tryHit()
                System.out.println("‚úì Correct! " + session.username + " scores. Scores: " + room.playerA + "=" + room.scoreA + ", " + room.playerB + "=" + room.scoreB);
                
                // Check if game is finished
                if (room.isFinished()) {
                    System.out.println("Game finished! All differences found.");
                    broadcastUpdate(room, 0);
                    endGame(room, "all-found");
                    return;
                }
            } else {
                // Missed
                System.out.println("‚úó Miss! No difference at (" + x + ", " + y + ")");
            }
            
            // Always switch turn after any click (hit or miss)
            // Increment turnSeq FIRST to invalidate old timeout, then schedule new one
            room.currentTurn = room.currentTurn.equals(room.playerA) ? room.playerB : room.playerA;
            room.turnSeq++;
            System.out.println("Turn switched to: " + room.currentTurn + " (seq=" + room.turnSeq + ")");
            
            // Reset timer and broadcast update with NEW turnSeq
            scheduleTurnTimeout(room);
            broadcastUpdate(room, turnSeconds * 1000);
        }
    }

    public void onGameQuit(ClientSession session, Map<?,?> payload) {
        String roomId = String.valueOf(payload.get("roomId"));
        GameRoom room = rooms.get(roomId);
        if (room == null) return;
        synchronized (room) {
            endGame(room, session.username + "-quit");
        }
    }

    public void onInviteResponse(ClientSession session, Map<?,?> payload) {
        String fromUser = String.valueOf(payload.get("fromUser"));
        boolean accepted = Boolean.parseBoolean(String.valueOf(payload.get("accepted")));
        ClientSession inviter = lobby.getOnline(fromUser);
        if (inviter != null) {
            inviter.send(new Message(Protocol.INVITE_RESPONSE, Map.of("fromUser", session.username, "accepted", accepted)).toJson());
        }
        if (accepted && inviter != null) {
            startGame(fromUser, session.username);
        }
    }

    private void notifyStart(GameRoom room) {
        Map<String,Object> payload = new HashMap<>();
        payload.put("roomId", room.id);
        payload.put("imageSetId", room.imageSetId);
        payload.put("imageWidth", room.imageWidth);
        payload.put("imageHeight", room.imageHeight);
        payload.put("differences", room.differences);
        try {
            if (room.imgLeft != null && room.imgRight != null) {
                String b64L = java.util.Base64.getEncoder().encodeToString(room.imgLeft);
                String b64R = java.util.Base64.getEncoder().encodeToString(room.imgRight);
                payload.put("imgLeft", b64L);
                payload.put("imgRight", b64R);
            }
        } catch (Exception ignore) {}
        payload.put("currentTurn", room.currentTurn);
        sendToPlayers(room, new Message(Protocol.GAME_START, payload));
        broadcastUpdate(room, turnSeconds * 1000);
    }

    private void broadcastUpdate(GameRoom room, long remainingMs) {
        Map<String,Object> upd = new HashMap<>();
        upd.put("scores", Map.of(room.playerA, room.scoreA, room.playerB, room.scoreB));
        upd.put("found", room.found);
        upd.put("lastFinder", room.lastFinder);
        upd.put("nextTurn", room.currentTurn);
        upd.put("remainingTurnMs", remainingMs);
        sendToPlayers(room, new Message(Protocol.GAME_UPDATE, upd));
    }

    private void sendToPlayers(GameRoom room, Message msg) {
        String json = msg.toJson();
        ClientSession a = lobby.getOnline(room.playerA);
        ClientSession b = lobby.getOnline(room.playerB);
        if (a != null) a.send(json);
        if (b != null) b.send(json);
    }

    private void scheduleTurnTimeout(GameRoom room) {
        room.nextDeadline = System.currentTimeMillis() + turnSeconds * 1000L;
        long capturedSeq = room.turnSeq;
        System.out.println("üìÖ Scheduling timeout for seq=" + capturedSeq + ", turn=" + room.currentTurn + ", delay=" + turnSeconds + "s");
        scheduler.schedule(() -> onTimeout(room.id, capturedSeq), turnSeconds, TimeUnit.SECONDS);
    }

    private void onTimeout(String roomId, long seq) {
        GameRoom room = rooms.get(roomId);
        if (room == null) {
            System.out.println("‚è∞ Timeout fired but room not found: " + roomId);
            return;
        }
        synchronized (room) {
            System.out.println("‚è∞ Timeout fired: seq=" + seq + ", current room.turnSeq=" + room.turnSeq + ", finished=" + room.finished);
            if (room.turnSeq != seq || room.finished) {
                System.out.println("  ‚û° Timeout IGNORED (stale or finished)");
                return; // already advanced or game finished
            }
            
            System.out.println("  ‚û° Timeout VALID! Auto-switching turn from " + room.currentTurn);
            // Switch turn directly (increment seq to invalidate this timeout)
            room.currentTurn = room.currentTurn.equals(room.playerA) ? room.playerB : room.playerA;
            room.turnSeq++;
            System.out.println("  ‚û° Turn auto-switched to: " + room.currentTurn + " (new seq=" + room.turnSeq + ")");
            
            scheduleTurnTimeout(room);
            broadcastUpdate(room, turnSeconds * 1000); // Send full time for new turn
        }
    }

    private void endGame(GameRoom room, String reason) {
        room.finished = true;
        Map<String,Object> payload = new HashMap<>();
        payload.put("reason", reason);
        payload.put("scores", Map.of(room.playerA, room.scoreA, room.playerB, room.scoreB));
        String winner;
        if (room.scoreA > room.scoreB) winner = room.playerA;
        else if (room.scoreB > room.scoreA) winner = room.playerB;
        else winner = "DRAW";
        payload.put("result", winner);
        sendToPlayers(room, new Message(Protocol.GAME_END, payload));
        rooms.remove(room.id);
        lobby.setBusy(room.playerA, false);
        lobby.setBusy(room.playerB, false);
        
        try {
            // L∆∞u k·∫øt qu·∫£ tr·∫≠n
            User a = userRepo.findByUsername(room.playerA);
            User b = userRepo.findByUsername(room.playerB);
            if (a != null && b != null) {
                matchRepo.saveMatch(a.id, b.id, room.scoreA, room.scoreB);
                
                // C·∫≠p nh·∫≠t stats ng∆∞·ªùi ch∆°i
                if (winner.equals(room.playerA)) {
                    userRepo.updateStats(a.id, room.scoreA, true, false, false);
                    userRepo.updateStats(b.id, room.scoreB, false, true, false);
                } else if (winner.equals(room.playerB)) {
                    userRepo.updateStats(a.id, room.scoreA, false, true, false);
                    userRepo.updateStats(b.id, room.scoreB, true, false, false);
                } else {
                    userRepo.updateStats(a.id, room.scoreA, false, false, true);
                    userRepo.updateStats(b.id, room.scoreB, false, false, true);
                }
            }
        } catch (Exception e) {
            System.err.println("Failed to save match result: " + e.getMessage());
        }
    }

    private List<Map<String,Object>> sampleDifferences() {
        // Simple built-in difference points with LARGER radius for easier clicking
        List<Map<String,Object>> diffs = new ArrayList<>();
        diffs.add(Map.of("x", 100, "y", 120, "radius", 50));
        diffs.add(Map.of("x", 200, "y", 80, "radius", 50));
        diffs.add(Map.of("x", 260, "y", 160, "radius", 50));
        return diffs;
    }

    static class GameRoom {
        final String id;
        final String playerA;
        final String playerB;
        String currentTurn;
        int scoreA = 0;
        int scoreB = 0;
        final List<Map<String,Object>> differences; // x,y,radius
        final List<Map<String,Object>> found = new ArrayList<>();
        String lastFinder = null;
        boolean finished = false;
        long nextDeadline = 0;
        long turnSeq = 0;
        String imageSetId;
        int imageWidth;
        int imageHeight;
        byte[] imgLeft;
        byte[] imgRight;

        GameRoom(String id, String a, String b, List<Map<String,Object>> diffs) {
            this.id = id; this.playerA = a; this.playerB = b; this.currentTurn = a; this.differences = diffs;
        }

        boolean tryHit(double x, double y, String username) {
            System.out.println("üéØ Checking hit at click position: (" + x + ", " + y + ")");
            System.out.println("üìç Total differences to check: " + differences.size());
            
            for (int i = 0; i < differences.size(); i++) {
                Map<String,Object> d = differences.get(i);
                boolean already = found.stream().anyMatch(f -> f.get("x").equals(d.get("x")) && f.get("y").equals(d.get("y")));
                if (already) {
                    System.out.println("  Diff #" + i + ": ALREADY FOUND - skipping");
                    continue;
                }
                
                double targetX = ((Number)d.get("x")).doubleValue();
                double targetY = ((Number)d.get("y")).doubleValue();
                double r = ((Number)d.get("radius")).doubleValue();
                double dx = x - targetX;
                double dy = y - targetY;
                double distance = Math.sqrt(dx*dx + dy*dy);
                
                System.out.println("  Diff #" + i + ": center=(" + targetX + ", " + targetY + "), radius=" + r);
                System.out.println("    Distance from click: " + String.format("%.2f", distance) + " (need <= " + r + ")");
                
                if (dx*dx + dy*dy <= r*r) {
                    System.out.println("    ‚úÖ HIT! Adding to found list.");
                    // Add the difference with finder info
                    Map<String,Object> foundDiff = new HashMap<>(d);
                    foundDiff.put("finder", username);
                    found.add(foundDiff);
                    lastFinder = username;
                    if (username.equals(playerA)) scoreA++; else scoreB++;
                    return true;
                } else {
                    System.out.println("    ‚ùå TOO FAR");
                }
            }
            System.out.println("‚ùå No hit found at (" + x + ", " + y + ")");
            return false;
        }

        boolean isFinished() { return found.size() >= differences.size(); }

        void switchTurn() { currentTurn = currentTurn.equals(playerA) ? playerB : playerA; turnSeq++; }
    }
}
</file>

<file path="server/src/main/java/com/ltm/game/server/ImageSetRepository.java">
package com.ltm.game.server;

import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class ImageSetRepository {

    public ImageSet loadRandom() throws Exception {
        // Prefer most recent valid sets (with paths and at least 1 difference).
        String pickSql = "SELECT id, width, height, img_left_path, img_right_path FROM image_sets ORDER BY id DESC LIMIT 20";
        try (Connection c = Database.getConnection(); PreparedStatement ps = c.prepareStatement(pickSql)) {
            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    long id = rs.getLong("id");
                    int w = rs.getInt("width");
                    int h = rs.getInt("height");
                    String leftPath = rs.getString("img_left_path");
                    String rightPath = rs.getString("img_right_path");
                    List<Map<String,Object>> diffs = loadDiffs(c, id);
                    if (leftPath == null || rightPath == null || diffs.isEmpty()) continue;
                    byte[] leftBytes = readContent(leftPath);
                    byte[] rightBytes = readContent(rightPath);
                    if (leftBytes == null || rightBytes == null || leftBytes.length == 0 || rightBytes.length == 0) continue;
                    return new ImageSet(id, w, h, leftBytes, rightBytes, diffs);
                }
            }
        }
        return null;
    }

    private byte[] readContent(String relative) throws Exception {
        if (relative == null) return null;
        String base = ServerProperties.load().getProperty("content.dir", "admin/content/imagesets");
        // Resolve from user.dir (project root)
        Path p = Paths.get(System.getProperty("user.dir"), base, relative);
        System.out.println("Loading image: " + p.toAbsolutePath() + " (exists: " + Files.exists(p) + ")");
        if (!Files.exists(p)) {
            System.err.println("Image file not found: "+p.toAbsolutePath());
            return null;
        }
        byte[] bytes = Files.readAllBytes(p);
        System.out.println("Loaded " + bytes.length + " bytes from " + relative);
        return bytes;
    }

    private List<Map<String,Object>> loadDiffs(Connection c, long setId) throws Exception {
        List<Map<String,Object>> list = new ArrayList<>();
        try (PreparedStatement ps = c.prepareStatement("SELECT x, y, radius FROM image_differences WHERE set_id = ?")) {
            ps.setLong(1, setId);
            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    list.add(Map.of(
                            "x", rs.getInt("x"),
                            "y", rs.getInt("y"),
                            "radius", rs.getInt("radius")
                    ));
                }
            }
        }
        return list;
    }

    public record ImageSet(long id, int width, int height, byte[] left, byte[] right, List<Map<String,Object>> diffs) {}
}
</file>

<file path="server/src/main/java/com/ltm/game/server/LobbyService.java">
package com.ltm.game.server;

import com.ltm.game.shared.Message;
import com.ltm.game.shared.Protocol;
import com.ltm.game.shared.models.User;
import com.ltm.game.shared.models.UserStatus;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

public class LobbyService {
    private final ConcurrentHashMap<String, ClientSession> online = new ConcurrentHashMap<>();
    private final UserRepository userRepo = new UserRepository();

    public static class AuthResult {
        public final boolean success; public final String message; public final User user;
        public AuthResult(boolean success, String message, User user) {this.success=success; this.message=message; this.user=user;}
    }

    public AuthResult authenticate(String username, String password) {
        try {
            User u = userRepo.findByUsername(username);
            if (u == null) {
                // auto-register for demo
                userRepo.createUser(username, password);
                u = userRepo.findByUsername(username);
            } else {
                if (!userRepo.verifyPassword(username, password)) {
                    return new AuthResult(false, "Sai m·∫≠t kh·∫©u", null);
                }
            }
            return new AuthResult(true, "OK", u);
        } catch (Exception e) {
            return new AuthResult(false, "L·ªói h·ªá th·ªëng: "+e.getMessage(), null);
        }
    }

    public void onLogin(ClientSession session, User user) {
        online.put(user.username, session);
        broadcastLobby();
    }

    public void onDisconnect(ClientSession session) {
        if (session.username != null) {
            online.remove(session.username);
            broadcastLobby();
        }
    }

    public void setBusy(String username, boolean busy) {
        ClientSession s = online.get(username);
        if (s != null) {
            s.inGame = busy;
            broadcastLobby();
        }
    }

    public void onInviteSend(ClientSession from, Map<?,?> payload) {
        String toUser = String.valueOf(payload.get("toUser"));
        ClientSession target = online.get(toUser);
        if (target != null) {
            target.send(new Message(Protocol.INVITE_RECEIVED, Map.of("fromUser", from.username)).toJson());
        }
    }

    public void onInviteResponse(ClientSession session, Map<?,?> payload) {
        // This will be handled by GameService when accepted; for now just forward response to inviter
        String fromUser = String.valueOf(payload.get("fromUser"));
        boolean accepted = Boolean.parseBoolean(String.valueOf(payload.get("accepted")));
        ClientSession inviter = online.get(fromUser);
        if (inviter != null) {
            inviter.send(new Message(Protocol.INVITE_RESPONSE, Map.of("fromUser", session.username, "accepted", accepted)).toJson());
        }
    }

    public List<UserStatus> currentLobby() {
        List<UserStatus> list = new ArrayList<>();
        online.forEach((name, sess) -> list.add(new UserStatus(name, userRepo.safeGetTotalPoints(name), sess.inGame?"busy":"idle")));
        return list;
    }

    public void broadcastLobby() {
        List<UserStatus> list = currentLobby();
        Message msg = new Message(Protocol.LOBBY_LIST, list);
        String json = msg.toJson();
        online.values().forEach(s -> s.send(json));
    }

    public ClientSession getOnline(String username) { return online.get(username); }
}
</file>

<file path="server/src/main/java/com/ltm/game/server/MatchRepository.java">
package com.ltm.game.server;

import java.sql.Connection;
import java.sql.PreparedStatement;

public class MatchRepository {
    public void saveMatch(int playerAId, int playerBId, int scoreA, int scoreB) throws Exception {
        String result = scoreA>scoreB?"A":scoreB>scoreA?"B":"DRAW";
        try (Connection c = Database.getConnection(); PreparedStatement ps = c.prepareStatement(
                "INSERT INTO matches(player_a_id, player_b_id, score_a, score_b, result) VALUES (?,?,?,?,?)")) {
            ps.setInt(1, playerAId);
            ps.setInt(2, playerBId);
            ps.setInt(3, scoreA);
            ps.setInt(4, scoreB);
            ps.setString(5, result);
            ps.executeUpdate();
        }
    }
}
</file>

<file path="server/src/main/java/com/ltm/game/server/ServerProperties.java">
package com.ltm.game.server;

import java.io.InputStream;
import java.util.Properties;

public class ServerProperties {
    public static Properties load() {
        Properties props = new Properties();
        try (InputStream in = ServerProperties.class.getClassLoader().getResourceAsStream("server-config.properties")) {
            if (in != null) {
                props.load(in);
            }
        } catch (Exception e) {
            System.err.println("Failed to load server-config.properties: " + e.getMessage());
        }
        
        String dbUrl = System.getenv("DB_URL");
        if (dbUrl != null) {
            props.setProperty("db.url", dbUrl);
        }
        
        String dbUser = System.getenv("DB_USER");
        if (dbUser != null) {
            props.setProperty("db.user", dbUser);
        }
        
        String dbPassword = System.getenv("DB_PASSWORD");
        if (dbPassword != null) {
            props.setProperty("db.password", dbPassword);
        }
        
        return props;
    }
}
</file>

<file path="server/src/main/java/com/ltm/game/server/UserRepository.java">
package com.ltm.game.server;

import com.ltm.game.shared.models.User;

import java.sql.*;
import java.util.Optional;

public class UserRepository {
    private Connection getConn() throws Exception {
        return Database.getConnection();
    }

    public User findByUsername(String username) throws Exception {
        try (Connection c = getConn(); PreparedStatement ps = c.prepareStatement("SELECT id, username, total_points, total_wins, total_losses, total_draws FROM users WHERE username=?")) {
            ps.setString(1, username);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    User u = new User();
                    u.id = rs.getInt("id");
                    u.username = rs.getString("username");
                    u.totalPoints = rs.getInt("total_points");
                    u.totalWins = rs.getInt("total_wins");
                    u.totalLosses = rs.getInt("total_losses");
                    u.totalDraws = rs.getInt("total_draws");
                    return u;
                }
            }
        }
        return null;
    }

    public boolean verifyPassword(String username, String password) throws Exception {
        try (Connection c = getConn(); PreparedStatement ps = c.prepareStatement("SELECT password_hash FROM users WHERE username=?")) {
            ps.setString(1, username);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    String hash = rs.getString(1);
                    // WARNING: demo only (plain text); replace with proper hashing e.g., BCrypt
                    return hash.equals(password);
                }
            }
        }
        return false;
    }

    public void createUser(String username, String password) throws Exception {
        try (Connection c = getConn(); PreparedStatement ps = c.prepareStatement("INSERT INTO users(username, password_hash) VALUES (?,?)")) {
            ps.setString(1, username);
            ps.setString(2, password);
            ps.executeUpdate();
        }
    }

    public int safeGetTotalPoints(String username) {
        try (Connection c = getConn(); PreparedStatement ps = c.prepareStatement("SELECT total_points FROM users WHERE username=?")) {
            ps.setString(1, username);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) return rs.getInt(1);
            }
        } catch (Exception ignored) {}
        return 0;
    }

    public void updateStats(int userId, int points, boolean win, boolean loss, boolean draw) throws Exception {
        try (Connection c = getConn(); PreparedStatement ps = c.prepareStatement(
                "UPDATE users SET total_points = total_points + ?, " +
                "total_wins = total_wins + ?, " +
                "total_losses = total_losses + ?, " +
                "total_draws = total_draws + ? " +
                "WHERE id = ?")) {
            ps.setInt(1, points);
            ps.setInt(2, win ? 1 : 0);
            ps.setInt(3, loss ? 1 : 0);
            ps.setInt(4, draw ? 1 : 0);
            ps.setInt(5, userId);
            ps.executeUpdate();
        }
    }
}
</file>

<file path="server/src/main/resources/server-config.properties">
server.port=5050
db.url=jdbc:mysql://localhost:3306/spotgame
db.user=root
db.password=root
turn.seconds=15
content.dir=admin/content/imagesets
</file>

<file path="server/.gitignore">
target
</file>

<file path="server/Dockerfile">
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /build
COPY pom.xml ./
COPY shared ./shared
COPY server ./server
COPY client/pom.xml ./client/pom.xml
COPY admin/pom.xml ./admin/pom.xml
RUN mvn install -N -DskipTests && \
    mvn clean install -DskipTests -pl shared && \
    mvn clean package -DskipTests -pl server

FROM eclipse-temurin:17-jre
WORKDIR /app
COPY --from=build /build/server/target/server-0.1.0-SNAPSHOT.jar /app/server.jar
COPY --from=build /build/server/target/classes/server-config.properties /app/server-config.properties
RUN mkdir -p /app/admin/content/imagesets
EXPOSE 5050
CMD ["java", "-jar", "server.jar"]
</file>

<file path="shared/src/main/java/com/ltm/game/shared/models/LeaderboardEntry.java">
package com.ltm.game.shared.models;

public class LeaderboardEntry {
    private String username;
    private int totalPoints;
    private int totalWins;

    public LeaderboardEntry() {}

    public LeaderboardEntry(String username, int totalPoints, int totalWins) {
        this.username = username;
        this.totalPoints = totalPoints;
        this.totalWins = totalWins;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public int getTotalPoints() {
        return totalPoints;
    }

    public void setTotalPoints(int totalPoints) {
        this.totalPoints = totalPoints;
    }

    public int getTotalWins() {
        return totalWins;
    }

    public void setTotalWins(int totalWins) {
        this.totalWins = totalWins;
    }
}
</file>

<file path="shared/src/main/java/com/ltm/game/shared/models/User.java">
package com.ltm.game.shared.models;

public class User {
    public int id;
    public String username;
    public int totalPoints;
    public int totalWins;
    public int totalLosses;
    public int totalDraws;

    public User() {}

    public User(int id, String username, int totalPoints) {
        this.id = id;
        this.username = username;
        this.totalPoints = totalPoints;
    }

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public int getTotalPoints() {
        return totalPoints;
    }

    public void setTotalPoints(int totalPoints) {
        this.totalPoints = totalPoints;
    }

    public int getTotalWins() {
        return totalWins;
    }

    public void setTotalWins(int totalWins) {
        this.totalWins = totalWins;
    }

    public int getTotalLosses() {
        return totalLosses;
    }

    public void setTotalLosses(int totalLosses) {
        this.totalLosses = totalLosses;
    }

    public int getTotalDraws() {
        return totalDraws;
    }

    public void setTotalDraws(int totalDraws) {
        this.totalDraws = totalDraws;
    }
}
</file>

<file path="shared/src/main/java/com/ltm/game/shared/models/UserStatus.java">
package com.ltm.game.shared.models;

public class UserStatus {
    private String username;
    private int totalPoints;
    private String status;

    public UserStatus() {}

    public UserStatus(String username, int totalPoints, String status) {
        this.username = username;
        this.totalPoints = totalPoints;
        this.status = status;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public int getTotalPoints() {
        return totalPoints;
    }

    public void setTotalPoints(int totalPoints) {
        this.totalPoints = totalPoints;
    }

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }
}
</file>

<file path="shared/src/main/java/com/ltm/game/shared/Message.java">
package com.ltm.game.shared;

import com.google.gson.Gson;
import com.google.gson.annotations.SerializedName;

public class Message {
    private static final Gson GSON = new Gson();

    @SerializedName("type")
    public String type;

    @SerializedName("payload")
    public Object payload;

    public Message() {}

    public Message(String type, Object payload) {
        this.type = type;
        this.payload = payload;
        }

    public String toJson() {
        return GSON.toJson(this);
    }

    public static Message fromJson(String json) {
        return GSON.fromJson(json, Message.class);
    }
}
</file>

<file path="shared/src/main/java/com/ltm/game/shared/Protocol.java">
package com.ltm.game.shared;

public final class Protocol {
    private Protocol() {}

    public static final String AUTH_LOGIN = "auth/login";
    public static final String AUTH_RESULT = "auth/result";

    public static final String ERROR = "error";

    public static final String LOBBY_LIST = "lobby/list";
    public static final String INVITE_SEND = "invite/send";
    public static final String INVITE_RECEIVED = "invite/received";
    public static final String INVITE_RESPONSE = "invite/response";

    public static final String GAME_START = "game/start";
    public static final String GAME_CLICK = "game/click";
    public static final String GAME_UPDATE = "game/update";
    public static final String GAME_END = "game/end";
    public static final String GAME_QUIT = "game/quit";

    public static final String TIMER_TICK = "timer/tick";

    public static final String LEADERBOARD = "leaderboard/data";
}
</file>

<file path="shared/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.example</groupId>
        <artifactId>spot-the-difference</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>
    <artifactId>shared</artifactId>
    <name>shared</name>
    <dependencies>
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
        </dependency>
    </dependencies>
</project>
</file>

<file path="docker-compose.yaml">
version: "3.9"
services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: spotgame
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./Dump20251102.sql:/docker-entrypoint-initdb.d/Dump20251102.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  db_data:
</file>

<file path="Dump20251102.sql">
CREATE DATABASE  IF NOT EXISTS `spotgame` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */ /*!80016 DEFAULT ENCRYPTION='N' */;
USE `spotgame`;
-- MySQL dump 10.13  Distrib 8.0.38, for Win64 (x86_64)
--
-- Host: localhost    Database: spotgame
-- ------------------------------------------------------
-- Server version	8.0.39

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!50503 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `image_differences`
--

DROP TABLE IF EXISTS `image_differences`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `image_differences` (
  `id` int NOT NULL AUTO_INCREMENT,
  `set_id` int NOT NULL,
  `x` int NOT NULL,
  `y` int NOT NULL,
  `radius` int NOT NULL,
  PRIMARY KEY (`id`),
  KEY `set_id` (`set_id`),
  CONSTRAINT `image_differences_ibfk_1` FOREIGN KEY (`set_id`) REFERENCES `image_sets` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=57 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `image_differences`
--

LOCK TABLES `image_differences` WRITE;
/*!40000 ALTER TABLE `image_differences` DISABLE KEYS */;
INSERT INTO `image_differences` VALUES (31,5,73,26,32),(32,5,145,27,32),(33,5,96,99,32),(34,5,64,176,32),(35,5,273,177,32),(36,5,243,118,32),(37,5,239,64,32),(38,6,165,43,25),(39,6,2,168,25),(40,6,207,339,25),(41,6,63,38,25),(42,6,236,190,25),(43,6,153,176,25),(44,6,74,159,25),(45,6,114,246,25),(46,6,204,135,25),(47,7,988,53,110),(48,7,709,69,110),(49,7,609,480,110),(50,7,78,613,110),(51,7,963,421,110),(52,7,288,73,110),(53,7,436,101,110),(54,7,405,432,110),(55,7,518,321,110),(56,7,18,170,110);
/*!40000 ALTER TABLE `image_differences` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `image_sets`
--

DROP TABLE IF EXISTS `image_sets`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `image_sets` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(100) COLLATE utf8mb4_unicode_ci NOT NULL,
  `width` int NOT NULL,
  `height` int NOT NULL,
  `img_left_path` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `img_right_path` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `image_sets`
--

LOCK TABLES `image_sets` WRITE;
/*!40000 ALTER TABLE `image_sets` DISABLE KEYS */;
INSERT INTO `image_sets` VALUES (5,'skibidi',320,224,'1762063653457_left.jpg','1762063653457_right.jpg','2025-11-02 06:07:33'),(6,'set-1762099271457',249,375,'1762099271462_left.jpg','1762099271462_right.jpg','2025-11-02 16:01:11'),(7,'set-1762099872903',1104,670,'1762099872910_left.jpg','1762099872910_right.jpg','2025-11-02 16:11:13');
/*!40000 ALTER TABLE `image_sets` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `matches`
--

DROP TABLE IF EXISTS `matches`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `matches` (
  `id` int NOT NULL AUTO_INCREMENT,
  `player_a_id` int NOT NULL,
  `player_b_id` int NOT NULL,
  `score_a` int NOT NULL,
  `score_b` int NOT NULL,
  `result` enum('A','B','DRAW') COLLATE utf8mb4_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `player_a_id` (`player_a_id`),
  KEY `player_b_id` (`player_b_id`),
  CONSTRAINT `matches_ibfk_1` FOREIGN KEY (`player_a_id`) REFERENCES `users` (`id`),
  CONSTRAINT `matches_ibfk_2` FOREIGN KEY (`player_b_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `matches`
--

LOCK TABLES `matches` WRITE;
/*!40000 ALTER TABLE `matches` DISABLE KEYS */;
INSERT INTO `matches` VALUES (1,1,2,10,8,'A','2025-10-25 12:22:09'),(2,1,3,7,9,'B','2025-10-25 12:22:09'),(3,2,3,8,8,'DRAW','2025-10-25 12:22:09'),(4,3,4,10,5,'A','2025-10-25 12:22:09'),(5,4,5,6,7,'B','2025-10-25 12:22:09'),(6,5,1,9,9,'DRAW','2025-10-25 12:22:09'),(7,2,5,10,7,'A','2025-10-25 12:22:09'),(8,6,7,3,4,'B','2025-11-02 06:14:55'),(9,7,6,2,5,'B','2025-11-02 09:27:53'),(10,6,7,5,2,'A','2025-11-02 11:39:48'),(11,7,6,4,3,'A','2025-11-02 15:02:22'),(12,7,6,3,4,'B','2025-11-02 15:10:46'),(13,7,6,3,4,'B','2025-11-02 15:48:53'),(14,7,6,3,4,'B','2025-11-02 15:57:30'),(15,7,6,4,5,'B','2025-11-02 16:05:40');
/*!40000 ALTER TABLE `matches` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `users`
--

DROP TABLE IF EXISTS `users`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `users` (
  `id` int NOT NULL AUTO_INCREMENT,
  `username` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL,
  `password_hash` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `total_points` int NOT NULL DEFAULT '0',
  `total_wins` int NOT NULL DEFAULT '0',
  `total_losses` int NOT NULL DEFAULT '0',
  `total_draws` int NOT NULL DEFAULT '0',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`),
  KEY `idx_users_username` (`username`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `users`
--

LOCK TABLES `users` WRITE;
/*!40000 ALTER TABLE `users` DISABLE KEYS */;
INSERT INTO `users` VALUES (1,'alice','ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f',120,3,1,0,'2025-10-25 12:22:09'),(2,'bob','ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f',90,2,2,0,'2025-10-25 12:22:09'),(3,'charlie','ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f',150,4,0,0,'2025-10-25 12:22:09'),(4,'david','ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f',60,1,3,0,'2025-10-25 12:22:09'),(5,'eva','ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f',100,2,1,1,'2025-10-25 12:22:09'),(6,'huy','123',133,7,3,1,'2025-10-25 12:22:09'),(7,'hung','123',125,3,7,1,'2025-10-25 12:22:09');
/*!40000 ALTER TABLE `users` ENABLE KEYS */;
UNLOCK TABLES;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2025-11-02 23:13:43
</file>

<file path="Makefile">
.PHONY: help build clean db server client admin all stop logs

MAVEN := mvn
DOCKER_COMPOSE := docker-compose

help:
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë           Spot The Difference - Makefile Commands            ‚ïë"
	@echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
	@echo "‚ïë  make build         - Build t·∫•t c·∫£ modules                    ‚ïë"
	@echo "‚ïë  make clean         - Clean build artifacts                   ‚ïë"
	@echo "‚ïë  make db            - Start MySQL database                    ‚ïë"
	@echo "‚ïë  make db-stop       - Stop MySQL database                     ‚ïë"
	@echo "‚ïë  make server        - Run game server                         ‚ïë"
	@echo "‚ïë  make client        - Run game client                         ‚ïë"
	@echo "‚ïë  make client1       - Run client instance 1                   ‚ïë"
	@echo "‚ïë  make client2       - Run client instance 2                   ‚ïë"
	@echo "‚ïë  make clients       - Run 2 clients (for testing)             ‚ïë"
	@echo "‚ïë  make admin         - Run admin uploader                      ‚ïë"
	@echo "‚ïë  make all           - Start DB + Server + Client              ‚ïë"
	@echo "‚ïë  make run           - Same as 'make all'                      ‚ïë"
	@echo "‚ïë  make stop          - Stop all running services               ‚ïë"
	@echo "‚ïë  make logs          - Show docker-compose logs                ‚ïë"
	@echo "‚ïë  make dev           - Development mode (DB + Server)          ‚ïë"
	@echo "‚ïë  make status        - Check service status                    ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

build:
	@echo "üî® Building all modules..."
	$(MAVEN) clean install -DskipTests
	@echo "‚úÖ Build completed!"

clean:
	@echo "üßπ Cleaning build artifacts..."
	$(MAVEN) clean
	@echo "‚úÖ Clean completed!"

db:
	@echo "üóÑÔ∏è  Starting MySQL database..."
	$(DOCKER_COMPOSE) up -d db
	@echo "‚è≥ Waiting for database to be ready..."
	@sleep 5
	$(DOCKER_COMPOSE) exec db mysqladmin ping -h 127.0.0.1 -proot || true
	@echo "‚úÖ Database is running on port 3306"

db-stop:
	@echo "üõë Stopping MySQL database..."
	$(DOCKER_COMPOSE) down
	@echo "‚úÖ Database stopped!"

server: build
	@echo "üöÄ Starting game server..."
	@cd server && java -jar target/server-0.1.0-SNAPSHOT.jar

client: build
	@echo "üéÆ Starting game client..."
	@cd client && $(MAVEN) javafx:run

client1:
	@echo "üéÆ Starting Client 1..."
	@cd client && $(MAVEN) javafx:run > /tmp/client1.log 2>&1 &
	@sleep 2
	@echo "‚úÖ Client 1 started!"

client2:
	@echo "üéÆ Starting Client 2..."
	@cd client && $(MAVEN) javafx:run > /tmp/client2.log 2>&1 &
	@sleep 2
	@echo "‚úÖ Client 2 started!"

clients: client1
	@echo "‚è≥ Waiting for Client 1 to initialize..."
	@sleep 5
	@$(MAKE) client2
	@sleep 3
	@echo ""
	@echo "üéÆ Both clients are running!"
	@echo "üìù Logs:"
	@echo "   Client 1: /tmp/client1.log"
	@echo "   Client 2: /tmp/client2.log"

admin: build
	@echo "‚öôÔ∏è  Starting admin uploader..."
	@cd admin && java -jar target/admin-0.1.0-SNAPSHOT.jar

dev: db
	@echo "üíª Development mode: Starting server..."
	@sleep 2
	@cd server && $(MAVEN) exec:java

all: build db
	@echo "üåü Starting all services..."
	@echo "üìä Database is ready"
	@echo "üöÄ Starting server in background..."
	@cd server && java -jar target/server-0.1.0-SNAPSHOT.jar & echo $$! > /tmp/spotgame-server.pid
	@sleep 3
	@echo "üéÆ Starting client..."
	@cd client && $(MAVEN) javafx:run

run: all

stop:
	@echo "üõë Stopping all services..."
	@if [ -f /tmp/spotgame-server.pid ]; then \
		kill `cat /tmp/spotgame-server.pid` 2>/dev/null || true; \
		rm /tmp/spotgame-server.pid; \
		echo "‚úÖ Server stopped"; \
	fi
	@pkill -f "com.ltm.game.client.ClientApp" 2>/dev/null || true
	@echo "‚úÖ Client stopped"
	@$(DOCKER_COMPOSE) down
	@echo "‚úÖ Database stopped"
	@echo "‚úÖ All services stopped!"

logs:
	@echo "üìã Showing database logs..."
	$(DOCKER_COMPOSE) logs -f db

db-reset: db-stop
	@echo "‚ö†Ô∏è  Removing database volumes..."
	$(DOCKER_COMPOSE) down -v
	@echo "üîÑ Recreating database..."
	$(DOCKER_COMPOSE) up -d db
	@echo "‚úÖ Database reset completed!"

test:
	@echo "üß™ Running tests..."
	$(MAVEN) test

install: build
	@echo "üì¶ Installing to local maven repository..."
	$(MAVEN) install

package:
	@echo "üì¶ Packaging applications..."
	$(MAVEN) package -DskipTests
	@echo "‚úÖ Package completed!"
	@echo "üìç Server JAR: server/target/server-0.1.0-SNAPSHOT.jar"
	@echo "üìç Client JAR: client/target/client-0.1.0-SNAPSHOT.jar"

status:
	@echo "üìä Service Status:"
	@echo ""
	@echo "Database:"
	@$(DOCKER_COMPOSE) ps db || echo "  ‚ùå Not running"
	@echo ""
	@echo "Server:"
	@ps aux | grep "server.*SNAPSHOT.jar" | grep -v grep || echo "  ‚ùå Not running"
	@echo ""
	@echo "Client:"
	@ps aux | grep "com.ltm.game.client.ClientApp" | grep -v grep || echo "  ‚ùå Not running"
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.example</groupId>
    <artifactId>spot-the-difference</artifactId>
    <version>0.1.0-SNAPSHOT</version>
    <packaging>pom</packaging>
    <name>Spot The Difference</name>

    <modules>
        <module>shared</module>
        <module>server</module>
        <module>client</module>
        <module>admin</module>
    </modules>

    <properties>
        <java.version>17</java.version>
        <maven.compiler.source>${java.version}</maven.compiler.source>
        <maven.compiler.target>${java.version}</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <gson.version>2.10.1</gson.version>
    <mysql.connector.version>8.4.0</mysql.connector.version>
        <javafx.version>21.0.3</javafx.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.google.code.gson</groupId>
                <artifactId>gson</artifactId>
                <version>${gson.version}</version>
            </dependency>
            <dependency>
                <groupId>com.mysql</groupId>
                <artifactId>mysql-connector-j</artifactId>
                <version>${mysql.connector.version}</version>
            </dependency>
            <dependency>
                <groupId>org.openjfx</groupId>
                <artifactId>javafx-controls</artifactId>
                <version>${javafx.version}</version>
            </dependency>
            <dependency>
                <groupId>org.openjfx</groupId>
                <artifactId>javafx-graphics</artifactId>
                <version>${javafx.version}</version>
            </dependency>
            <dependency>
                <groupId>org.openjfx</groupId>
                <artifactId>javafx-fxml</artifactId>
                <version>${javafx.version}</version>
            </dependency>
            <dependency>
                <groupId>org.openjfx</groupId>
                <artifactId>javafx-media</artifactId>
                <version>${javafx.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

</project>
</file>

<file path="admin/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.example</groupId>
        <artifactId>spot-the-difference</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>
    <artifactId>admin</artifactId>
    <name>admin-uploader</name>

    <dependencies>
        <dependency>
            <groupId>org.openjfx</groupId>
            <artifactId>javafx-controls</artifactId>
        </dependency>
        <dependency>
            <groupId>org.openjfx</groupId>
            <artifactId>javafx-graphics</artifactId>
        </dependency>
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.openjfx</groupId>
                <artifactId>javafx-maven-plugin</artifactId>
                <version>0.0.8</version>
                <configuration>
                    <mainClass>com.ltm.game.admin.UploaderApp</mainClass>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <version>3.3.0</version>
                <configuration>
                    <archive>
                        <manifest>
                            <mainClass>com.ltm.game.admin.UploaderApp</mainClass>
                        </manifest>
                    </archive>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path="client/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.example</groupId>
        <artifactId>spot-the-difference</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>
    <artifactId>client</artifactId>
    <name>client</name>
    <dependencies>
        <dependency>
            <groupId>com.example</groupId>
            <artifactId>shared</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>org.openjfx</groupId>
            <artifactId>javafx-controls</artifactId>
        </dependency>
        <dependency>
            <groupId>org.openjfx</groupId>
            <artifactId>javafx-graphics</artifactId>
        </dependency>
        <dependency>
            <groupId>org.openjfx</groupId>
            <artifactId>javafx-fxml</artifactId>
        </dependency>
        <dependency>
            <groupId>org.openjfx</groupId>
            <artifactId>javafx-media</artifactId>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.openjfx</groupId>
                <artifactId>javafx-maven-plugin</artifactId>
                <version>0.0.8</version>
                <configuration>
                    <mainClass>com.ltm.game.client.ClientApp</mainClass>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <version>3.3.0</version>
                <configuration>
                    <archive>
                        <manifest>
                            <mainClass>com.ltm.game.client.ClientApp</mainClass>
                        </manifest>
                    </archive>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path=".gitignore">
# Maven
target/
pom.xml.tag
pom.xml.releaseBackup
pom.xml.versionsBackup
pom.xml.next
release.properties
dependency-reduced-pom.xml
buildNumber.properties
.mvn/timing.properties
.mvn/wrapper/maven-wrapper.jar

# Java
*.class
*.log
*.jar
*.war
*.nar
*.ear
*.zip
*.tar.gz
*.rar
hs_err_pid*
replay_pid*

# IDE
.idea/
*.iml
.vscode/
.settings/
.classpath
.project
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Application
*.pid
/tmp/
*.log
client.log

# Database
db_data/

# Admin content (uploaded images)
admin/content/
admin/admin/content/
</file>

<file path="README.md">
# üéÆ Spot The Difference - Quick Start Guide

## üìã Y√™u c·∫ßu h·ªá th·ªëng

- Java 17+
- Maven 3.6+
- Docker & Docker Compose (cho database)

## üöÄ Ch·∫°y nhanh v·ªõi Makefile

### Xem t·∫•t c·∫£ commands

```bash
make help
```

### Ch·∫°y to√†n b·ªô ·ª©ng d·ª•ng (Database + Server + Client)

```bash
make all
# ho·∫∑c
make run
```

### Ch·∫°y t·ª´ng th√†nh ph·∫ßn ri√™ng l·∫ª

#### 1. Start Database

```bash
make db
```

#### 2. Run Server

```bash
make server
```

#### 3. Run Client

```bash
make client
```

#### 4. Run Admin Tool

```bash
make admin
```

### Development Mode (DB + Server ch·∫°y v·ªõi Maven)

```bash
make dev
```

### D·ª´ng t·∫•t c·∫£ services

```bash
make stop
```

### C√°c commands h·ªØu √≠ch kh√°c

**Build project:**

```bash
make build
```

**Clean build artifacts:**

```bash
make clean
```

**Ki·ªÉm tra tr·∫°ng th√°i services:**

```bash
make status
```

**Xem database logs:**

```bash
make logs
```

**Reset database:**

```bash
make db-reset
```

**Package applications:**

```bash
make package
```

## üìÇ C·∫•u tr√∫c Project sau Refactoring

```
game/
‚îú‚îÄ‚îÄ Makefile                    # Build & run automation
‚îú‚îÄ‚îÄ client/                     # JavaFX Game Client
‚îÇ   ‚îî‚îÄ‚îÄ src/main/java/com/ltm/game/client/
‚îÇ       ‚îú‚îÄ‚îÄ ClientApp.java      # Main application
‚îÇ       ‚îú‚îÄ‚îÄ controllers/        # FXML Controllers
‚îÇ       ‚îú‚îÄ‚îÄ views/             # Game views
‚îÇ       ‚îú‚îÄ‚îÄ models/            # Data models
‚îÇ       ‚îî‚îÄ‚îÄ services/          # Business services
‚îú‚îÄ‚îÄ server/                    # Game Server
‚îÇ   ‚îî‚îÄ‚îÄ src/main/java/com/example/server/
‚îú‚îÄ‚îÄ shared/                    # Shared models & protocol
‚îÇ   ‚îî‚îÄ‚îÄ src/main/java/com/ltm/game/shared/
‚îú‚îÄ‚îÄ admin/                     # Admin tool for uploading images
‚îî‚îÄ‚îÄ docker-compose.yaml        # Database setup
```

## üéØ Workflow th√¥ng th∆∞·ªùng

### L·∫ßn ƒë·∫ßu setup:

```bash
# 1. Build t·∫•t c·∫£
make build

# 2. Start database
make db

# 3. Ch·∫°y server (terminal 1)
make server

# 4. Ch·∫°y client (terminal 2)
make client
```

### Development:

```bash
# Ch·∫°y t·∫•t c·∫£ m·ªôt l·∫ßn
make all
```

### K·∫øt th√∫c:

```bash
# D·ª´ng t·∫•t c·∫£
make stop
```

## üîß C·∫•u h√¨nh

### Database

- Host: localhost
- Port: 3306
- Database: spotgame
- Username: root
- Password: root

### Server

- Port: 5050

## üêõ Troubleshooting

### Database kh√¥ng start ƒë∆∞·ª£c

```bash
# Ki·ªÉm tra Docker ƒëang ch·∫°y
docker ps

# Reset database
make db-reset
```

### Server kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c database

```bash
# Ki·ªÉm tra database ƒë√£ s·∫µn s√†ng ch∆∞a
make logs

# ƒê·ª£i cho healthcheck pass
```

### Client kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server

```bash
# Ki·ªÉm tra server ƒëang ch·∫°y
make status

# Xem log server
ps aux | grep server
```

## üìù Notes

- Makefile t·ª± ƒë·ªông build tr∆∞·ªõc khi ch·∫°y c√°c services
- Database data ƒë∆∞·ª£c persist trong Docker volume
- Server t·∫°o fat JAR v·ªõi t·∫•t c·∫£ dependencies
- Client ch·∫°y qua Maven JavaFX plugin

## üé® Package Name Convention

To√†n b·ªô project ƒë√£ ƒë∆∞·ª£c refactor sang package name m·ªõi:

- **Old**: `com.example.*`
- **New**: `com.ltm.game.*`

---

**Happy Gaming! üéÆ**
</file>

<file path="server/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.example</groupId>
        <artifactId>spot-the-difference</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>
    <artifactId>server</artifactId>
    <name>server</name>
    <dependencies>
        <dependency>
            <groupId>com.example</groupId>
            <artifactId>shared</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-shade-plugin</artifactId>
                <version>3.5.1</version>
                <executions>
                    <execution>
                        <phase>package</phase>
                        <goals>
                            <goal>shade</goal>
                        </goals>
                        <configuration>
                            <transformers>
                                <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                    <mainClass>com.ltm.game.server.GameServer</mainClass>
                                </transformer>
                            </transformers>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>exec-maven-plugin</artifactId>
                <version>3.2.0</version>
                <configuration>
                    <mainClass>com.ltm.game.server.GameServer</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
</file>

</files>
